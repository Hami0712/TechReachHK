<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-en="Conditions Game ‚Äî If, Else, Loops" data-zh="Ê¢ù‰ª∂ÈÅäÊà≤ ‚Äî If, Else, Âæ™Áí∞">Conditions Game ‚Äî If, Else, Loops</title>
  <style>
    :root{
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --panel:#ffffff;      
      --ink:#0f172a;        
      --muted:#475569;      
      --accent:#2563eb;     
      --accent-2:#22c55e;   
      --accent-3:#f59e0b;   
      --accent-4:#ef4444;   
      --accent-5:#8b5cf6;   
      --line:#cbd5e1;       
      --chip:#eef2ff;
      --shadow: 0 10px 25px rgba(0,0,0,0.1);
      --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
      --good:#16a34a; 
      --bad:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink); background:var(--bg); min-height:100vh;
    }
    .wrap{max-width:1200px; margin-inline:auto; padding:24px;}
    
    /* Header styling matching Index Page */
    header{
      display:flex; align-items:center; gap:20px; margin-bottom:32px; 
      background:rgba(255,255,255,0.95); padding:24px; border-radius:20px; 
      box-shadow:var(--shadow); backdrop-filter:blur(10px);
    }
    header .logo{
      width:60px;height:60px; border-radius:16px; 
      background:linear-gradient(135deg,var(--accent),#60a5fa); 
      display:grid; place-items:center; color:#fff; font-weight:800; font-size:24px;
      box-shadow: 0 8px 16px rgba(37, 99, 235, 0.3);
    }
    h1{font-size:clamp(28px,4vw,42px); margin:0; background:linear-gradient(135deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
    .subtitle{color:var(--muted); margin-top:8px; font-size:18px;}

    /* Navigation */
    .nav-section{
      display:flex; align-items:center; gap:16px; margin-left:auto;
    }
    
    /* Navigation buttons - consistent sizing */
    .back-btn, .next-lesson-btn, .back-to-index-btn{
      background:var(--accent); color:#fff; border:none; padding:12px 20px; 
      border-radius:12px; font-weight:600; cursor:pointer; transition:all 0.3s ease;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      text-decoration:none; display:inline-flex; align-items:center; gap:8px;
      min-width: 140px; height: 48px; justify-content: center;
    }
    .back-btn:hover{
      background:#1d4ed8; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }
    
    /* Next Lesson button specific styling */
    .next-lesson-btn{
      background:var(--accent-5); 
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    .next-lesson-btn:hover{
      background:#7c3aed; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
    }
    
    /* Back to All Lessons button specific styling */
    .back-to-index-btn{
      background:var(--accent-2); 
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }
    .back-to-index-btn:hover{
      background:#16a34a; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }
    
    /* Language toggle */
    .lang-toggle{
      margin-left:auto; display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,0.1); padding:8px 16px; 
      border-radius:20px; border:1px solid rgba(255,255,255,0.2);
      backdrop-filter:blur(10px); transition:all 0.3s ease;
    }
    .lang-toggle:hover{background:rgba(255,255,255,0.2);}
    .lang-toggle button{
      background:none; border:none; color:var(--ink); font-size:14px; 
      font-weight:600; padding:4px 8px; border-radius:8px; 
      cursor:pointer; transition:all 0.2s ease;
    }
    .lang-toggle button.active{
      background:var(--accent); color:#fff; box-shadow:0 2px 8px rgba(37, 99, 235, 0.3);
    }
    .lang-toggle button:not(.active):hover{
      background:rgba(37, 99, 235, 0.1); color:var(--accent);
    }

    /* Main content */
    main{max-width:1200px; margin:0 auto; padding:0 24px;}
    .game-card{
      background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
      backdrop-filter: blur(10px); border-radius:20px; padding:32px; 
      box-shadow:var(--shadow); border:2px solid rgba(255,255,255,0.2);
    }
    .game-header{
      display:flex; align-items:center; justify-content:space-between; 
      margin-bottom:24px; padding-bottom:16px; 
      border-bottom:2px solid rgba(139, 92, 246, 0.2);
    }
    .level-info{
      display:flex; align-items:center; gap:12px;
    }
    .level-badge{
      background:linear-gradient(135deg,var(--accent-5),#a78bfa); 
      color:#fff; padding:8px 16px; border-radius:12px; font-weight:700;
      box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
    }
    .level-text{color:var(--muted); font-size:16px;}
    
    /* Game content layout */
    .game-content{display:flex; gap:32px; align-items:flex-start;}
    .game-board-section{flex-shrink:0;}
    .game-controls-section{flex:1; min-width:0;}
    
    /* Board styling */
    .boardWrap{
      position:relative; display:inline-block; padding:16px; 
      background:rgba(255,255,255,0.8); border-radius:16px; 
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .board{display:grid; grid-template-columns: repeat(10, 36px); gap:6px;}
    .cell{
      width:36px; height:36px; border:2px solid var(--accent); 
      border-radius:8px; display:flex; align-items:center; 
      justify-content:center; background:#fff;
      transition: all 0.2s ease;
    }
    .start{background:#d1fae5; border-color:var(--accent-2);}
    .goal{background:#fde68a; border-color:var(--accent-3);}
    .wall{background:#c7d2fe; border-color:var(--accent); position:relative;}
    .wall::after{
      content:""; position:absolute; inset:6px; 
      border:2px dashed var(--accent); border-radius:4px; opacity:.6;
    }
    #robot{
      position:absolute; top:16px; left:16px; width:36px; height:36px; 
      display:flex; align-items:center; justify-content:center; 
      pointer-events:none; will-change:transform; 
      transition: transform 220ms ease; font-size:20px;
    }
    
    /* Controls */
    .controls-section{
      background:rgba(255,255,255,0.7); border-radius:16px; 
      padding:20px; margin-bottom:20px;
      border:2px solid rgba(139, 92, 246, 0.2);
    }
    .controls-row{display:flex; gap:12px; margin-bottom:16px;}
    .btn{
      padding:12px 24px; border:2px solid var(--accent-5); 
      background:#fff; color:var(--accent-5); border-radius:12px; 
      font-size:16px; font-weight:600; cursor:pointer; 
      transition:all 0.3s ease; box-shadow: 0 4px 8px rgba(139, 92, 246, 0.2);
    }
    .btn:hover{
      background:var(--accent-5); color:#fff; transform:translateY(-2px);
      box-shadow: 0 6px 12px rgba(139, 92, 246, 0.3);
    }
    .btn:focus{outline:3px solid rgba(139, 92, 246, 0.4);}
    
    /* Code editor */
    .code-section{
      background:rgba(255,255,255,0.7); border-radius:16px; 
      overflow:hidden; border:2px solid rgba(139, 92, 246, 0.2);
    }
    .code-header{
      padding:16px 20px; background:rgba(139, 92, 246, 0.1); 
      border-bottom:2px solid rgba(139, 92, 246, 0.2);
      font-weight:600; color:var(--ink);
    }
    #code{
      width:100%; height:280px; border:0; padding:20px; 
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
      font-size:16px; background:rgba(255,255,255,0.9); 
      resize:vertical; color:var(--ink);
    }
    .code-footer{
      padding:12px 20px; background:rgba(139, 92, 246, 0.05); 
      font-size:14px; color:var(--muted); line-height:1.4;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
      background:rgba(139, 92, 246, 0.1); border-radius:6px; 
      padding:2px 6px; border:1px solid rgba(139, 92, 246, 0.3); 
      color:var(--accent-5); font-weight:600;
    }
    
    /* Feedback */
    .feedback{
      margin:16px 0; padding:12px 16px; border-radius:12px; 
      font-weight:600; min-height:20px;
    }
    .feedback.muted{
      background:rgba(71, 85, 105, 0.1); color:var(--muted); font-weight:400;
    }
    .feedback.good{
      background:rgba(22, 163, 74, 0.1); color:var(--good); 
      border:2px solid rgba(22, 163, 74, 0.2);
    }
    .feedback.bad{
      background:rgba(220, 38, 38, 0.1); color:var(--bad); 
      border:2px solid rgba(220, 38, 38, 0.2);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .wrap{padding:16px;}
      header{flex-direction:column; text-align:center; gap:16px;}
      .nav-section{margin-left:0; flex-direction:column; gap:12px;}
      .game-content{flex-direction:column; gap:20px;}
      .controls-row{flex-direction:column;}
      h1{font-size:24px;}
    }
    
    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{transition:none !important;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">üß†</div>
      <div>
        <h1 data-en="Conditions Game" data-zh="Ê¢ù‰ª∂ÈÅäÊà≤">Conditions Game</h1>
        <div class="subtitle" data-en="Master conditional programming with if, elif, else, while, and for loops" data-zh="ÊéåÊè°Ê¢ù‰ª∂Á∑®Á®ãÔºöif„ÄÅelif„ÄÅelse„ÄÅwhile Âíå for Âæ™Áí∞">Master conditional programming with if, elif, else, while, and for loops</div>
      </div>
      <div class="lang-toggle">
        <button class="active" onclick="switchLanguage('en')">EN</button>
        <button onclick="switchLanguage('zh')">ÁπÅ‰∏≠</button>
      </div>
    </header>
    
    <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
      <a href="6. Conditions Life Game.html" class="back-btn">
        ‚Üê <span data-en="Previous Lesson" data-zh="‰∏ä‰∏ÄË™≤">Previous Lesson</span>
      </a>
      <button id="nextLessonBtn" class="next-lesson-btn" data-en="Next Lesson ‚Üí" data-zh="‰∏ã‰∏ÄË™≤ ‚Üí">Next Lesson ‚Üí</button>
      <button id="backToIndexBtn" class="back-to-index-btn" data-en="Back to All Lessons" data-zh="ËøîÂõûÈ¶ñÈ†Å">Back to All Lessons</button>
    </div>

    <main>
      <div class="game-card">
        <div class="game-header">
          <div class="level-info">
            <div class="level-badge">
              <span data-en="Level" data-zh="ÈóúÂç°">Level</span> <span id="lvl">1</span>/4
            </div>
            <div class="level-text" data-en="Practice conditional logic and loops" data-zh="Á∑¥ÁøíÊ¢ù‰ª∂ÈÇèËºØÂíåÂæ™Áí∞">Practice conditional logic and loops</div>
          </div>
        </div>

        <div class="game-content">
          <div class="game-board-section">
            <div class="boardWrap">
              <div id="board" class="board"></div>
              <div id="robot">ü§ñ</div>
            </div>
          </div>

          <div class="game-controls-section">
            <div class="controls-section">
              <div class="controls-row">
                <button id="runBtn" class="btn" data-en="Run Program" data-zh="ÈÅãË°åÁ®ãÂºè">Run Program</button>
                <button id="resetBtn" class="btn" data-en="Reset" data-zh="ÈáçÁΩÆ">Reset</button>
              </div>
              <div id="feedback" class="feedback muted"></div>
            </div>

            <div class="code-section">
              <div class="code-header">
                <span data-en="Write your program:" data-zh="Á∑®ÂØ´‰Ω†ÁöÑÁ®ãÂºèÔºö">Write your program:</span>
                <span data-en="You can use" data-zh="‰Ω†ÂèØ‰ª•‰ΩøÁî®">You can use</span> 
                <span class="kbd">if</span>/<span class="kbd">elif</span>/<span class="kbd">else</span>, 
                <span class="kbd">while</span>, <span class="kbd">for</span>, 
                <span data-en="and" data-zh="Âíå">and</span> <span class="kbd">repeat</span>.
              </div>
              <textarea id="code" aria-label="code editor" placeholder="# Write your code here..."></textarea>
              <div class="code-footer">
                <div data-en="Examples:" data-zh="‰æãÂ≠êÔºö">Examples:</div>
                <span class="kbd">if wall_right(): up()</span>, 
                <span class="kbd">while not at_goal(): right()</span>, 
                <span class="kbd">repeat 3: down()</span>, 
                <span class="kbd">repeat 2:</span> ‚Ä¶ <span class="kbd">end</span>
                <br>
                <span data-en="Use Cmd/Ctrl+Enter to run." data-zh="‰ΩøÁî® Cmd/Ctrl+Enter ‰æÜÈÅãË°å„ÄÇ">Use Cmd/Ctrl+Enter to run.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
const DIRS = { Right:[1,0], Left:[-1,0], Up:[0,-1], Down:[0,1] };
const DIR_NAME = { right:'Right', left:'Left', up:'Up', down:'Down' };
let running = false;
let runGeneration = 0;
let _advanceTimer = null;
let lvl = 0;

// 4 levels showcasing conditions with bilingual hints
const LEVELS = [
  {
    start:[0,9], goal:[3,8], walls:[[1,9]], 
    hint_en:'Use if wall_right(): up() else: right() repeatedly to pass.',
    hint_zh:'‰ΩøÁî® if wall_right(): up() else: right() ÈáçË§áÈÄöÈÅé„ÄÇ',
    starter:`repeat 4:
  if wall_right():
    up()
  else:
    right()
end`
  },
  {
    start:[0,9], goal:[5,7], walls:[[1,9],[2,9],[3,9],[4,9],[4,8]], 
    hint_en:'Use while not at_goal(): prefer right else up.',
    hint_zh:'‰ΩøÁî® while not at_goal()ÔºöÂÑ™ÂÖàÂêëÂè≥ÔºåÂê¶ÂâáÂêë‰∏ä„ÄÇ',
    starter:`while not at_goal():
  if not wall_right():
    right()
  elif not wall_up():
    up()
  else:
    down()
end`
  },
  {
    start:[0,9], goal:[6,6], walls:[[2,9],[3,9],[3,8],[3,7]], 
    hint_en:'Use while not at_goal(): if not wall_right, else if not wall_up.',
    hint_zh:'‰ΩøÁî® while not at_goal()ÔºöÂ¶ÇÊûúÂè≥ÈÇäÊ≤íÁâÜÔºåÂê¶ÂâáÂ¶ÇÊûú‰∏äÈù¢Ê≤íÁâÜ„ÄÇ',
    starter:`while not at_goal():
  if not wall_right():
    right()
  elif not wall_up():
    up()
  else:
    down()
end`
  },
  {
    start:[0,9], goal:[9,0], 
    walls:[[1,9],[2,9],[3,9],[4,9],[5,9],[6,9],[6,8],[6,7],[5,7],[4,7],[3,7],[2,7],[2,6],[2,5],[2,4],[3,4],[4,4],[5,4],[6,4],[7,4]], 
    hint_en:'While not at_goal(): use if/elif/else to choose direction.',
    hint_zh:'While not at_goal()Ôºö‰ΩøÁî® if/elif/else ÈÅ∏ÊìáÊñπÂêë„ÄÇ',
    starter:`while not at_goal():
  if not wall_right():
    right()
  elif not wall_up():
    up()
  elif not wall_down():
    down()
  else:
    left()
end`
  }
];

function currentLevel(){ return LEVELS[lvl]; }

function setFeedback(msg, cls){
  const el = document.getElementById('feedback');
  el.className = 'feedback ' + (cls || 'muted');
  el.textContent = msg;
}

function drawBoard(){
  const L = currentLevel();
  const b = document.getElementById('board');
  b.innerHTML = '';
  const stepPx = 36+6;
  const robot = document.getElementById('robot');
  robot.style.transform = `translate(${L.start[0]*stepPx}px, ${L.start[1]*stepPx}px)`;
  
  for (let y=0;y<10;y++){
    for (let x=0;x<10;x++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      if (L.walls.some(w=> w[0]===x && w[1]===y)) cell.classList.add('wall');
      if (x===L.start[0] && y===L.start[1]) cell.classList.add('start');
      if (x===L.goal[0] && y===L.goal[1]){ cell.classList.add('goal'); cell.textContent = '‚òÖ'; }
      b.appendChild(cell);
    }
  }
  
  document.getElementById('lvl').textContent = (lvl+1);
  document.getElementById('code').value = L.starter;
  
  // Set hint based on current language
  const currentLang = getCurrentLanguage();
  const hint = currentLang === 'zh' ? L.hint_zh : L.hint_en;
  const editText = currentLang === 'zh' ? ' Á∑®ËºØ‰∏¶ÈÅãË°å„ÄÇ' : ' Edit and run.';
  setFeedback(hint + editText, 'muted');
}

function applyMove(pos, mv){
  const d = DIRS[mv];
  return { x: pos.x + d[0], y: pos.y + d[1] };
}

function inBounds(p){ return p.x>=0 && p.x<10 && p.y>=0 && p.y<10; }
function isWall(p){ return currentLevel().walls.some(w=> w[0]===p.x && w[1]===p.y); }

async function animate(steps){
  if (running) return;
  running = true;
  const myGen = ++runGeneration;
  const stepPx = 36+6;
  const robot = document.getElementById('robot');
  const L = currentLevel();
  let pos = { x: L.start[0], y: L.start[1] };
  
  for (let i=0;i<steps.length;i++){
    if (myGen !== runGeneration) { break; }
    const next = applyMove(pos, steps[i]);
    
    if (!inBounds(next)){
      const currentLang = getCurrentLanguage();
      const msg = currentLang === 'zh' ? `Âú®Á¨¨ ${i+1} Ê≠•Ë∂ÖÂá∫ÈÇäÁïå„ÄÇ` : `Went out of bounds at step ${i+1}.`;
      setFeedback(msg, 'bad');
      break;
    }
    if (isWall(next)){
      const currentLang = getCurrentLanguage();
      const msg = currentLang === 'zh' ? `Âú®Á¨¨ ${i+1} Ê≠•ÊíûÂà∞ÁâÜÂ£Å„ÄÇ` : `Hit a wall at step ${i+1}.`;
      setFeedback(msg, 'bad');
      break;
    }
    
    pos = next;
    robot.style.transform = `translate(${pos.x*stepPx}px, ${pos.y*stepPx}px)`;
    await new Promise(r=> setTimeout(r, 230));
  }
  
  if (pos.x===L.goal[0] && pos.y===L.goal[1]){
    const currentLang = getCurrentLanguage();
    const msg = currentLang === 'zh' ? 'ÈÇèËºØÂæàÊ£íÔºÅÂâçÈÄ≤‰∏≠‚Ä¶' : 'Nice logic! Advancing‚Ä¶';
    setFeedback(msg, 'good');
    _advanceTimer && clearTimeout(_advanceTimer);
    _advanceTimer = setTimeout(()=>{ if (myGen===runGeneration) nextLevel(); }, 700);
  }
  
  running = false;
}

// Parser functions (keeping original logic)
function splitSemicolonsPreserve(lines){
  const out = [];
  lines.forEach(line=>{
    const parts = line.split(';').map(s=> s.trim()).filter(Boolean);
    out.push(...parts);
  });
  return out;
}

function parseSimpleCommand(cmd){
  const mm = cmd.match(/^(right|left|up|down)\s*\(\s*(\d+)?\s*\)$/i);
  if (mm){
    const dir = DIR_NAME[mm[1].toLowerCase()];
    const n = mm[2] ? parseInt(mm[2],10) : 1;
    return Array(n).fill(dir);
  }
  return null;
}

function compileProgram(src){
  const rawLines = src.replace(/\r/g,'').split("\n");
  const lines = rawLines;
  let i = 0;

  function peek(){ return lines[i] ?? ''; }
  function trimLine(s){ return s.replace(/#.*$/, '').trim(); }

  function parseBlock(terminators){
    const terms = Object.assign({ end:true, elif:false, else:false, consumeEnd:true }, terminators || {});
    let steps = [];
    while (i < lines.length){
      const raw = peek();
      const line = trimLine(raw);
      if (!line){ i++; continue; }
      if (/^end$/i.test(line)){
        if (terms.consumeEnd){ i++; }
        break;
      }
      if (terms.elif && /^elif\b/i.test(line)) break;
      if (terms.else && /^else\s*:/i.test(line)) break;

      let m = line.match(/^repeat\s+(\d+)\s*:\s*$/i);
      if (m){
        i++;
        const times = parseInt(m[1],10);
        const inner = parseBlock({ end:true, consumeEnd:true });
        for (let t=0;t<times;t++){ steps.push(...inner); }
        continue;
      }
      
      m = line.match(/^while\s+(.+):\s*$/i);
      if (m){
        i++;
        const condSrc = m[1];
        const body = parseBlock({ end:true, consumeEnd:true });
        steps.push({ type:'while', cond:condSrc, body });
        continue;
      }
      
      m = line.match(/^if\s+(.+):\s*$/i);
      if (m){
        i++;
        const chain = [];
        const firstBody = parseBlock({ end:true, elif:true, else:true, consumeEnd:false });
        chain.push({ kind:'if', cond:m[1], body:firstBody });
        
        while (i < lines.length){
          const l2 = trimLine(peek());
          const em = l2.match(/^elif\s+(.+):\s*$/i);
          if (em){
            i++;
            const b = parseBlock({ end:true, elif:true, else:true, consumeEnd:false });
            chain.push({ kind:'elif', cond:em[1], body:b });
            continue;
          }
          const om = l2.match(/^else\s*:\s*$/i);
          if (om){
            i++;
            const b = parseBlock({ end:true, consumeEnd:false });
            chain.push({ kind:'else', body:b });
          }
          break;
        }
        steps.push({ type:'ifchain', chain });
        continue;
      }
      
      m = line.match(/^for\s+\w+\s+in\s+range\s*\(\s*(\d+)\s*\)\s*:\s*$/i);
      if (m){
        i++;
        const count = parseInt(m[1],10);
        const body = parseBlock({ end:true, consumeEnd:true });
        steps.push({ type:'repeat', times:count, body });
        continue;
      }

      const parts = splitSemicolonsPreserve([line]);
      for (const part of parts){
        const simple = parseSimpleCommand(part);
        if (simple){ steps.push(...simple); }
        else {
          const currentLang = getCurrentLanguage();
          const msg = currentLang === 'zh' ? 'Êú™Áü•Êåá‰ª§: ' + part : 'Unknown command: ' + part;
          throw new Error(msg);
        }
      }
      i++;
    }
    return steps;
  }

  i = 0;
  const ast = parseBlock();
  
  function evalCond(cond, pos){
  const s = cond.trim();

  // Generic NOT support
  const nm = s.match(/^not\s+(.+)$/i);
  if (nm) return !evalCond(nm[1], pos);

  if (/^not\s+at_goal\(\)$/i.test(s)) return !(pos.x===L.goal[0] && pos.y===L.goal[1]);
  if (/^at_goal\(\)$/i.test(s)) return (pos.x===L.goal[0] && pos.y===L.goal[1]);

  // Wall checks (out of bounds counts as wall)
  if (/^wall_right\(\)$/i.test(s)){
    const next = applyMove(pos,'Right');
    return !inBounds(next) || isWall(next);
  }
  if (/^wall_left\(\)$/i.test(s)){
    const next = applyMove(pos,'Left');
    return !inBounds(next) || isWall(next);
  }
  if (/^wall_up\(\)$/i.test(s)){
    const next = applyMove(pos,'Up');
    return !inBounds(next) || isWall(next);
  }
  if (/^wall_down\(\)$/i.test(s)){
    const next = applyMove(pos,'Down');
    return !inBounds(next) || isWall(next);
  }

  return false;
}

  const L = currentLevel();
  let pos = { x: L.start[0], y: L.start[1] };
  const out = [];

  function exec(nodes){
    for (const node of nodes){
      if (typeof node === 'string'){
        const oldPos = {x: pos.x, y: pos.y};
        out.push(node);
        pos = applyMove(pos, node);
        console.log(`Moving ${node} from (${oldPos.x},${oldPos.y}) to (${pos.x},${pos.y})`);
        continue;
      }
      if (node.type==='repeat'){
        for (let t=0;t<node.times;t++) exec(node.body);
        continue;
      }
      if (node.type==='while'){
        let guard = 0;
        while (evalCond(node.cond, pos) && guard < 200){
          exec(node.body);
          guard++;
        }
        continue;
      }
      if (node.type==='ifchain'){
        let taken = false;
        for (const arm of node.chain){
          if (arm.kind==='if' || arm.kind==='elif'){
            if (evalCond(arm.cond, pos)){
              exec(arm.body);
              taken = true;
              break;
            }
          } else if (arm.kind==='else'){
            exec(arm.body);
            taken = true;
            break;
          }
        }
        continue;
      }
    }
  }

  exec(ast);
  return out;
}

async function runProgram(){
  try{
    const steps = compileProgram(document.getElementById('code').value);
    await animate(steps);
  } catch(err){
    setFeedback(err.message, 'bad');
  }
}

function nextLevel(){
  if (lvl < LEVELS.length-1){
    lvl++;
    drawBoard();
  } else {
    const currentLang = getCurrentLanguage();
    const msg = currentLang === 'zh' ? '‰Ω†ÂÆåÊàê‰∫ÜÊâÄÊúâÊ¢ù‰ª∂ÈóúÂç°ÔºÅüéâ' : 'You finished all conditions levels! üéâ';
    setFeedback(msg, 'good');
  }
}

// Language switching functionality
function getCurrentLanguage(){
  return document.documentElement.lang === 'zh-Hant' ? 'zh' : 'en';
}

function switchLanguage(lang) {
  // Update button states
  document.querySelectorAll('.lang-toggle button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Update all elements with data attributes
  document.querySelectorAll('[data-en][data-zh]').forEach(element => {
    if (lang === 'zh') {
      element.innerHTML = element.getAttribute('data-zh');
    } else {
      element.innerHTML = element.getAttribute('data-en');
    }
  });
  
  // Update HTML lang attribute
  document.documentElement.lang = lang === 'zh' ? 'zh-Hant' : 'en';
  
  // Update feedback to current language
  drawBoard();
  
  // Store language preference
  localStorage.setItem('preferredLanguage', lang);
}

// Bind UI
document.getElementById('runBtn').addEventListener('click', runProgram);
document.getElementById('resetBtn').addEventListener('click', ()=>{
  runGeneration++;
  running = false;
  if (_advanceTimer){ clearTimeout(_advanceTimer); _advanceTimer = null; }
  drawBoard();
});

window.addEventListener('keydown', (e)=>{
  if (e.key==='Enter' && (e.metaKey || e.ctrlKey)){
    e.preventDefault();
    runProgram();
  }
});

// Load saved language preference on page load
document.addEventListener('DOMContentLoaded', function() {
  const savedLang = localStorage.getItem('preferredLanguage') || 'en';
  if (savedLang === 'zh') {
    // Update button states
    document.querySelectorAll('.lang-toggle button').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector('.lang-toggle button[onclick="switchLanguage(\'zh\')"]').classList.add('active');
    
    // Update content
    document.querySelectorAll('[data-en][data-zh]').forEach(element => {
      element.innerHTML = element.getAttribute('data-zh');
    });
    document.documentElement.lang = 'zh-Hant';
  }
  
  // Initialize navigation buttons
  initializeNavigationButtons();
  
  drawBoard();
});

// Navigation functions
function nextLesson(){
  console.log('Next Lesson button clicked!');
  window.location.href = '8. AND OR NOT Logic.html';
}

function backToIndex(){
  console.log('Back to All Lessons button clicked!');
  window.location.href = '../index.html';
}

function initializeNavigationButtons(){
  // Bind Next Lesson button
  const nextLessonBtn = document.getElementById('nextLessonBtn');
  if (nextLessonBtn) {
    nextLessonBtn.addEventListener('click', nextLesson);
  }
  
  // Bind Back to All Lessons button
  const backToIndexBtn = document.getElementById('backToIndexBtn');
  if (backToIndexBtn) {
    backToIndexBtn.addEventListener('click', backToIndex);
  }
}
</script>
</body>
</html>
