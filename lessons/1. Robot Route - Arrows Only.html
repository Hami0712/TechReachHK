<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TechReach HK - Robot Route ‚Äî Arrows Only</title>
<style>
  :root{
    --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --panel:#ffffff;      
    --ink:#0f172a;        
    --muted:#475569;      
    --accent:#2563eb;     
    --accent-2:#22c55e;   
    --accent-3:#f59e0b;   
    --accent-4:#ef4444;   
    --accent-5:#8b5cf6;   
    --line:#cbd5e1;       
    --chip:#eef2ff;
    --shadow: 0 10px 25px rgba(0,0,0,0.1);
    --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
    --good:#16a34a; 
    --bad:#dc2626;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; min-height:100vh; }
  body{ font-size:18px; line-height:1.55; }
  .wrap{max-width:1200px; margin-inline:auto; padding:24px;}
  header{
    display:flex; align-items:center; gap:20px; margin-bottom:32px; 
    background:rgba(255,255,255,0.95); padding:24px; border-radius:20px; 
    box-shadow:var(--shadow); backdrop-filter:blur(10px);
  }
  header .logo{
    width:60px;height:60px; border-radius:16px; 
    background:linear-gradient(135deg,var(--accent),#60a5fa); 
    display:grid; place-items:center; color:#fff; font-weight:800; font-size:24px;
    box-shadow: 0 8px 16px rgba(37, 99, 235, 0.3);
  }
  header h1{font-size:clamp(28px,4vw,42px); margin:0; background:linear-gradient(135deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
  header .subtitle{color:var(--muted); margin-top:8px; font-size:18px;}
  
  /* Language toggle */
  .lang-toggle{
    margin-left:auto; display:flex; align-items:center; gap:8px;
    background:rgba(255,255,255,0.1); padding:8px 16px; 
    border-radius:20px; border:1px solid rgba(255,255,255,0.2);
    backdrop-filter:blur(10px); transition:all 0.3s ease;
  }
  .lang-toggle:hover{background:rgba(255,255,255,0.2);}
  .lang-toggle button{
    background:none; border:none; color:var(--ink); font-size:14px; 
    font-weight:600; padding:4px 8px; border-radius:8px; 
    cursor:pointer; transition:all 0.2s ease;
  }
  .lang-toggle button.active{
    background:var(--accent); color:#fff; box-shadow:0 2px 8px rgba(37, 99, 235, 0.3);
  }
  .lang-toggle button:not(.active):hover{
    background:rgba(37, 99, 235, 0.1); color:var(--accent);
  }
  
  /* Navigation buttons - consistent sizing */
  .back-btn, .next-lesson-btn{
    background:var(--accent); color:#fff; border:none; padding:12px 20px; 
    border-radius:12px; font-weight:600; cursor:pointer; transition:all 0.3s ease;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    min-width: 140px; height: 48px; justify-content: center;
  }
  .back-btn:hover{
    background:#1d4ed8; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
  }
  
  /* Next Lesson button specific styling */
  .next-lesson-btn{
    background:var(--accent-5); 
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }
  .next-lesson-btn:hover{
    background:#7c3aed; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
  }
  .next-lesson-btn:disabled{
    background:#9ca3af; cursor:not-allowed; transform:none; box-shadow:none;
  }
  
  /* Next Level button */
  .next-level-btn{
    background:var(--accent-2); color:#fff; border:none; padding:12px 20px; 
    border-radius:12px; font-weight:600; cursor:pointer; transition:all 0.3s ease;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    display:inline-flex; align-items:center; gap:8px; margin-top:12px;
  }
  .next-level-btn:hover{
    background:#16a34a; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
  }
  .next-level-btn:disabled{
    background:#9ca3af; cursor:not-allowed; transform:none; box-shadow:none;
  }
  
  main{ max-width:980px; margin:0 auto; padding:16px; }
  .card{ 
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
    backdrop-filter: blur(5px); border:2px solid var(--line); border-radius:16px; 
    padding:20px; margin:12px 0; box-shadow:var(--shadow); transition:all 0.3s ease;
  }
  .card:hover{ transform:translateY(-2px); box-shadow:var(--shadow-hover); }
  .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  button, .btn, select, input[type="number"]{
    font-size:18px; padding:10px 14px; border-radius:10px; border:2px solid #0f172a; background:#fff; color:#0f172a;
  }
  button:hover, .btn:hover{ outline:3px solid var(--accent); cursor:pointer; }
  button:focus, .btn:focus, select:focus, input:focus{ outline:4px solid var(--accent); }
  .hint{ background:#fff; border-left:6px solid var(--accent); padding:10px; border-radius:8px; }
  .good{ color:var(--good); font-weight:700; }
  .bad{ color:var(--bad); font-weight:700; }
  .sr{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
  .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#fff; border-radius:6px; padding:2px 6px; border:1px solid #0f172a; }
  /* Game grid */
  .board{ display:grid; grid-template-columns: repeat(10, 36px); gap:6px; }
  .cell{ width:36px; height:36px; border:2px solid #0f172a; border-radius:6px; display:flex; align-items:center; justify-content:center; background:#fff; }
  .start{ background:#d1fae5; }
  .goal{ background:#fde68a; }
  .wall{ background:#c7d2fe; position:relative; }
  .wall::after{ content:""; position:absolute; inset:6px; border:2px solid #0f172a; border-style:dashed; border-radius:4px; opacity:.8; }
  .block{ background:#fff; border:2px dashed #0f172a; padding:8px; border-radius:10px; min-height:52px; }
  .legend{ display:flex; gap:10px; align-items:center; font-size:16px; }
  .legend .swatch{ width:18px; height:18px; border:2px solid #0f172a; border-radius:4px; display:inline-block; }
  .mt{ margin-top:12px; }
  .sm{ font-size:14px; opacity:.9; }
  /* Animation overlay */
  .boardWrap{ position:relative; display:inline-block; }
  #robot{ position:absolute; top:0; left:0; width:36px; height:36px; display:flex; align-items:center; justify-content:center; pointer-events:none; will-change:transform; transition: transform 220ms ease; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">ü§ñ</div>
      <div>
        <h1 data-en="Robot Route" data-zh="Ê©üÂô®‰∫∫Ë∑ØÁ∑ö">Robot Route</h1>
        <div class="subtitle" data-en="Plan a route so the robot reaches the star. Avoid walls." data-zh="Ë¶èÂäÉË∑ØÁ∑öËÆìÊ©üÂô®‰∫∫Âà∞ÈÅîÊòüÊòü„ÄÇÈÅøÈñãÁâÜÂ£Å„ÄÇ">Plan a route so the robot reaches the star. Avoid walls.</div>
      </div>
      <div class="lang-toggle">
        <button class="active" onclick="switchLanguage('en')">EN</button>
        <button onclick="switchLanguage('zh')">ÁπÅ‰∏≠</button>
      </div>
    </header>
    
    <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
      <a href="../index.html" class="back-btn">
        ‚Üê <span data-en="Back to Lessons" data-zh="ËøîÂõûË™≤Á®ã">Back to Lessons</span>
      </a>
      <button id="nextLessonBtn" class="next-lesson-btn" data-en="Next Lesson ‚Üí" data-zh="‰∏ã‰∏ÄË™≤ ‚Üí">Next Lesson ‚Üí</button>
    </div>

<main>
  <div class="card">
    <p data-en="<strong>Learn:</strong> <em>Sequencing</em> ‚Äî give clear steps in order.<br/><strong>Why it matters:</strong> Computers follow steps exactly. Good plans avoid mistakes." data-zh="<strong>Â≠∏ÁøíÔºö</strong> <em>Â∫èÂàó</em> ‚Äî ÊåâÈ†ÜÂ∫èÁµ¶Âá∫Ê∏ÖÊô∞ÁöÑÊ≠•È©ü„ÄÇ<br/><strong>ÁÇ∫‰ªÄÈ∫ºÈáçË¶ÅÔºö</strong> ÈõªËÖ¶ÂÆåÂÖ®ÊåâÁÖßÊ≠•È©üÂü∑Ë°å„ÄÇÂ•ΩÁöÑË®àÂäÉÈÅøÂÖçÈåØË™§„ÄÇ"><strong>Learn:</strong> <em>Sequencing</em> ‚Äî give clear steps in order.<br/><strong>Why it matters:</strong> Computers follow steps exactly. Good plans avoid mistakes.</p>
  </div>

  <div class="card">
    <div class="row">
      <strong data-en="Level" data-zh="ÈóúÂç°">Level</strong> <span id="lvl">1</span>/8
      <button id="hintBtn" data-en="Hint" data-zh="ÊèêÁ§∫">Hint</button>
      <button id="resetBtn" data-en="Reset Level" data-zh="ÈáçÁΩÆÈóúÂç°">Reset Level</button>
      <button id="undoBtn" data-en="Undo" data-zh="Êí§Èä∑">Undo</button>
      <button id="runBtn" data-en="Run" data-zh="Âü∑Ë°å">Run</button>
    </div>
    <div id="hint" class="hint mt" hidden data-en="Try a short path. Add moves with the buttons or arrow keys. If you hit a wall, try a different way." data-zh="ÂòóË©¶‰∏ÄÊ¢ùÁü≠Ë∑ØÂæë„ÄÇÁî®ÊåâÈàïÊàñÊñπÂêëÈçµÊ∑ªÂä†ÁßªÂãï„ÄÇÂ¶ÇÊûúÊíûÂà∞ÁâÜÂ£ÅÔºåÂòóË©¶‰∏çÂêåÁöÑË∑ØÁ∑ö„ÄÇ">
      Try a short path. Add moves with the buttons or arrow keys. If you hit a wall, try a different way.
    </div>

    <div class="row mt" style="align-items:flex-start">
      <div>
        <div class="boardWrap">
          <div id="board" class="board" role="grid" aria-label="game board"></div>
          <div id="robot" aria-hidden="true">ü§ñ</div>
        </div>
        <div class="legend mt" aria-hidden="true">
          <span class="swatch" style="background:#d1fae5"></span> <span data-en="Start" data-zh="Ëµ∑Èªû">Start</span>
          <span class="swatch" style="background:#fde68a"></span> <span data-en="Goal" data-zh="ÁõÆÊ®ô">Goal</span>
          <span class="swatch" style="background:#c7d2fe"></span> <span data-en="Wall" data-zh="ÁâÜÂ£Å">Wall</span>
        </div>
      </div>
      <div style="flex:1">
        <div><strong data-en="Your steps:" data-zh="‰Ω†ÁöÑÊ≠•È©üÔºö">Your steps:</strong></div>
        <div id="block" class="block" aria-live="polite" data-en="(empty)" data-zh="(Á©∫ÁôΩ)">(empty)</div>
        <div class="row mt">
          <button data-mv="Right" aria-label="Add move Right" data-en="Right ‚Üí" data-zh="Âè≥ ‚Üí">Right ‚Üí</button>
          <button data-mv="Left" aria-label="Add move Left" data-en="Left ‚Üê" data-zh="Â∑¶ ‚Üê">Left ‚Üê</button>
          <button data-mv="Up" aria-label="Add move Up" data-en="Up ‚Üë" data-zh="‰∏ä ‚Üë">Up ‚Üë</button>
          <button data-mv="Down" aria-label="Add move Down" data-en="Down ‚Üì" data-zh="‰∏ã ‚Üì">Down ‚Üì</button>
          <button id="clearBtn" data-en="Clear" data-zh="Ê∏ÖÈô§">Clear</button>
        </div>
        <p class="sm mt" data-en="Tip: Use arrow keys to add a move. Press <span class='kbd'>Backspace</span> to undo, <span class='kbd'>Enter</span> to run." data-zh="ÊèêÁ§∫Ôºö‰ΩøÁî®ÊñπÂêëÈçµÊ∑ªÂä†ÁßªÂãï„ÄÇÊåâ <span class='kbd'>Backspace</span> Êí§Èä∑ÔºåÊåâ <span class='kbd'>Enter</span> Âü∑Ë°å„ÄÇ">Tip: Use arrow keys to add a move. Press <span class="kbd">Backspace</span> to undo, <span class="kbd">Enter</span> to run.</p>
        <div id="feedback" class="mt" aria-live="polite"></div>
        <button id="nextLevelBtn" class="next-level-btn" style="display:none;" data-en="Next Level ‚Üí" data-zh="‰∏ã‰∏ÄÈóú ‚Üí">Next Level ‚Üí</button>
      </div>
    </div>
  </div>
</main>
  </div>

<script>
// Language switching functionality
function switchLanguage(lang) {
  // Update button states
  document.querySelectorAll('.lang-toggle button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Update all elements with data attributes
  document.querySelectorAll('[data-en][data-zh]').forEach(element => {
    if (lang === 'zh') {
      element.innerHTML = element.getAttribute('data-zh');
    } else {
      element.innerHTML = element.getAttribute('data-en');
    }
  });
  
  // Update HTML lang attribute
  document.documentElement.lang = lang === 'zh' ? 'zh-Hant' : 'en';
  
  // Store language preference
  localStorage.setItem('preferredLanguage', lang);
}

// Load saved language preference on page load
document.addEventListener('DOMContentLoaded', function() {
  const savedLang = localStorage.getItem('preferredLanguage') || 'en';
  if (savedLang === 'zh') {
    // Update button states
    document.querySelectorAll('.lang-toggle button').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector('.lang-toggle button[onclick="switchLanguage(\'zh\')"]').classList.add('active');
    
    // Update content
    document.querySelectorAll('[data-en][data-zh]').forEach(element => {
      element.innerHTML = element.getAttribute('data-zh');
    });
    document.documentElement.lang = 'zh-Hant';
  }
  
  // Check next lesson availability after DOM is loaded
  checkNextLessonAvailability();
});

/* =====================
   Levels
   Each level has: grid size (10x10 fixed), start [x,y], goal [x,y], walls as array of [x,y]
   (0,0) is top-left
===================== */
const LEVELS = [
  { start:[0,9], goal:[3,9], walls:[] },                              // 1: straight line
  { start:[0,9], goal:[5,9], walls:[[2,9],[3,9]] },                   // 2: small detour
  { start:[0,9], goal:[7,7], walls:[[1,9],[1,8],[2,8],[3,8]] },       // 3: corner block
  { start:[0,9], goal:[9,6], walls:[[2,9],[3,9],[4,9],[5,9],[6,9]] }, // 4: must go up then right
  { start:[2,8], goal:[7,2], walls:[[3,8],[4,8],[5,8],[6,8],[7,8],[8,8],[8,7],[8,6],[7,6],[6,6],[5,6],[4,6],[3,6],[2,6],[1,6],[1,5],[2,5],[3,5],[4,5],[5,5],[6,5],[7,5],[8,5],[8,4],[7,4],[6,4],[5,4],[4,4],[3,4],[2,4],[1,4],[1,3],[2,3],[3,3],[4,3],[5,3],[6,3],[7,3],[8,3]] }, // 5: complex maze
  { start:[1,7], goal:[8,1], walls:[[2,7],[3,7],[4,7],[5,7],[6,7],[7,7],[8,7],[8,6],[7,6],[6,6],[5,6],[4,6],[3,6],[2,6],[1,6],[1,5],[2,5],[3,5],[4,5],[5,5],[6,5],[7,5],[8,5],[8,4],[7,4],[6,4],[5,4],[4,4],[3,4],[2,4],[1,4],[1,3],[2,3],[3,3],[4,3],[5,3],[6,3],[7,3],[8,3],[8,2],[7,2],[6,2],[5,2],[4,2],[3,2],[2,2],[1,2]] }, // 6: expert maze
  { start:[3,9], goal:[6,0], walls:[[0,9],[1,9],[2,9],[4,9],[5,9],[6,9],[7,9],[8,9],[9,9],       
    [0,0],[1,0],[2,0],[3,0],[4,0],[5,0],[7,0],[8,0],[9,0],        
    [0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[0,8],              
    [9,1],[9,2],[9,3],[9,4],[9,5],[9,6],[9,7],[9,8]] }, // 7: master maze - solvable
    {
  "start": [0, 6],
  "goal": [9, 3],
  "walls": [
    [1,6],[2,6],[3,6],[4,6],[5,6],[6,6],[7,6],[8,6],[9,6],
    [1,5],[2,5],[3,5],[4,5],[5,5],[6,5],[7,5],[8,5],[9,5],
    [1,4],[2,4],[3,4],[4,4],[5,4],[6,4],[7,4],[8,4],[9,4],
    /* (intentionally no walls on y=3 to keep the corridor open) */
    [0,2],[1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2],[8,2],[9,2],
    [0,1],[1,1],[2,1],[3,1],[4,1],[5,1],[6,1],[7,1],[8,1],[9,1],
    [0,0],[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0],[9,0]
  ]
}];

let level = 0;
let plan = []; // sequence of moves

// Lesson navigation mapping
const LESSON_NAVIGATION = {
  '1. Robot Route - Arrows Only.html': '2. Robot Route - Programming.html',
  '2. Robot Route - Programming.html': '3. Debugging Robot Route.html',
  '3. Debugging Robot Route.html': '4. Pattern Lab v4.html',
  '4. Pattern Lab v4.html': '5. Pattern Game.html',
  '5. Pattern Game.html': '6. Conditions Life Game.html',
  '6. Conditions Life Game.html': '7. Conditions Game.html',
  '7. Conditions Game.html': '8. AND OR NOT Logic.html',
  '8. AND OR NOT Logic.html': '9. Smart Home AND OR NOT.html',
  '9. Smart Home AND OR NOT.html': '10. Final Project - Maze Navigator.html'
  // Final lesson has no next lesson
};

function drawBoard() {
  const L = LEVELS[level];
  console.log('Drawing level:', level + 1, 'Start:', L.start, 'Goal:', L.goal, 'Walls:', L.walls);
  const b = document.getElementById('board');
  b.innerHTML = "";
  // Reset robot overlay position
  const robot = document.getElementById('robot');
  robot.style.transform = `translate(${L.start[0]*(36+6)}px, ${L.start[1]*(36+6)}px)`;
  for (let y=0; y<10; y++) {
    for (let x=0; x<10; x++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      if (L.walls.some(w=> w[0]===x && w[1]===y)) cell.classList.add('wall');
      if (x===L.start[0] && y===L.start[1]) { cell.classList.add('start'); }
      if (x===L.goal[0] && y===L.goal[1])  { cell.classList.add('goal');  cell.textContent = '‚òÖ'; }
      b.appendChild(cell);
    }
  }
  document.getElementById('lvl').textContent = (level+1);
  setFeedback("");
  renderPlan();
  document.getElementById('hint').hidden = true;
  // Hide Next Level button when starting a new level
  document.getElementById('nextLevelBtn').style.display = 'none';
}

function renderPlan(){
  const currentLang = document.documentElement.lang === 'zh-Hant' ? 'zh' : 'en';
  const emptyText = currentLang === 'zh' ? '(Á©∫ÁôΩ)' : '(empty)';
  const out = plan.length ? plan.join(" ‚Üí ") : emptyText;
  document.getElementById('block').textContent = out;
}

function setFeedback(msg, cls=''){
  const el = document.getElementById('feedback');
  el.className = 'mt ' + cls;
  el.textContent = msg;
}

function applyMove(mv, pos){
  const p = {x:pos.x, y:pos.y};
  if (mv==='Right') p.x++;
  if (mv==='Left') p.x--;
  if (mv==='Up') p.y--;
  if (mv==='Down') p.y++;
  return p;
}

function inBounds(p){ return p.x>=0 && p.x<10 && p.y>=0 && p.y<10; }
function isWall(p){ return LEVELS[level].walls.some(w=> w[0]===p.x && w[1]===p.y); }

let running = false;
function setControlsDisabled(disabled){
  document.querySelectorAll('button,[data-mv]').forEach(el=>{ el.disabled = disabled; });
}

async function run(){
  const L = LEVELS[level];
  let pos = {x:L.start[0], y:L.start[1]};
  console.log('Running level:', level + 1, 'Start position:', pos, 'Goal:', L.goal, 'Plan:', plan);
  if (plan.length===0){
    const currentLang = document.documentElement.lang === 'zh-Hant' ? 'zh' : 'en';
    const msg = currentLang === 'zh' ? 'ÂÖàÊ∑ªÂä†‰∏Ä‰∫õÁßªÂãï„ÄÇ' : 'Add some moves first.';
    setFeedback(msg, "bad");
    return;
  }
  if (running) return;
  running = true;
  setControlsDisabled(true);
  setFeedback("");
  const robot = document.getElementById('robot');
  const stepPx = 36+6; // cell + gap
  for (let i=0;i<plan.length;i++){
    const next = applyMove(plan[i], pos);
    console.log(`Step ${i+1}: Moving ${plan[i]} from (${pos.x},${pos.y}) to (${next.x},${next.y})`);
    if (!inBounds(next)){
      const currentLang = document.documentElement.lang === 'zh-Hant' ? 'zh' : 'en';
      const msg = currentLang === 'zh' ? 'Âú®Á¨¨'+(i+1)+'Ê≠•Ë∂ÖÂá∫ÈÇäÁïå„ÄÇÂòóË©¶‰∏çÂêåÁöÑË∑ØÁ∑ö„ÄÇ' : 'Out of the board at step '+(i+1)+'. Try a different way.';
      setFeedback(msg, "bad");
      break;
    }
    if (isWall(next)){
      const currentLang = document.documentElement.lang === 'zh-Hant' ? 'zh' : 'en';
      const msg = currentLang === 'zh' ? 'Âú®Á¨¨'+(i+1)+'Ê≠•ÊíûÂà∞ÁâÜÂ£Å„ÄÇÂòóË©¶ÁπûË°å„ÄÇ' : 'Hit a wall at step '+(i+1)+'. Try going around.';
      setFeedback(msg, "bad");
      break;
    }
    pos = next;
    robot.style.transform = `translate(${pos.x*stepPx}px, ${pos.y*stepPx}px)`;
    await new Promise(r=> setTimeout(r, 230));
  }
  console.log('Final position:', pos, 'Goal:', L.goal, 'Success:', pos.x===L.goal[0] && pos.y===L.goal[1]);
  // Evaluate end state
  if (pos.x===L.goal[0] && pos.y===L.goal[1]){
    const currentLang = document.documentElement.lang === 'zh-Hant' ? 'zh' : 'en';
    if (level < LEVELS.length-1){
      const msg = currentLang === 'zh' ? 'ÂæàÊ£íÁöÑË∑ØÁ∑öÔºÅ' : 'Great path!';
      setFeedback(msg, "good");
      // Show Next Level button instead of auto-advancing
      document.getElementById('nextLevelBtn').style.display = 'inline-flex';
    } else {
      const msg = currentLang === 'zh' ? '‰Ω†ÂÆåÊàê‰∫ÜÊâÄÊúâÈóúÂç°ÔºÅüéâ' : 'You finished all levels! üéâ';
      setFeedback(msg, "good");
      // Hide Next Level button on final level
      document.getElementById('nextLevelBtn').style.display = 'none';
    }
  } else if (plan.length>0) {
    const currentLang = document.documentElement.lang === 'zh-Hant' ? 'zh' : 'en';
    const dx = L.goal[0]-pos.x, dy = L.goal[1]-pos.y;
    let tip = currentLang === 'zh' ? "ÈÇÑÊ≤íÂà∞ÈÅî„ÄÇ " : "Not there yet. ";
    if (Math.abs(dx)+Math.abs(dy) <= 4){ tip += currentLang === 'zh' ? "‰Ω†ÂæàÊé•Ëøë‰∫Ü„ÄÇ " : "You are close. "; }
    if (dx>0) tip += currentLang === 'zh' ? "ÈúÄË¶ÅÊõ¥Â§öÂè≥Áßª„ÄÇ " : "Need more Right. ";
    if (dx<0) tip += currentLang === 'zh' ? "ÈúÄË¶ÅÊõ¥Â§öÂ∑¶Áßª„ÄÇ " : "Need more Left. ";
    if (dy>0) tip += currentLang === 'zh' ? "ÈúÄË¶ÅÊõ¥Â§ö‰∏ãÁßª„ÄÇ " : "Need more Down. ";
    if (dy<0) tip += currentLang === 'zh' ? "ÈúÄË¶ÅÊõ¥Â§ö‰∏äÁßª„ÄÇ " : "Need more Up. ";
    setFeedback(tip, "bad");
  }
  running = false;
  setControlsDisabled(false);
}

function addMove(mv){ plan.push(mv); renderPlan(); }
function undo(){ plan.pop(); renderPlan(); }
function clearPlan(){ plan.length = 0; renderPlan(); setFeedback(""); }

function nextLevel(){
  if (level < LEVELS.length - 1) {
    level++;
    plan = [];
    drawBoard();
    console.log('Advanced to level:', level + 1, 'Start:', LEVELS[level].start, 'Goal:', LEVELS[level].goal, 'Walls:', LEVELS[level].walls);
  }
}

function nextLesson(){
  const currentFile = window.location.pathname.split('/').pop();
  const nextLessonFile = LESSON_NAVIGATION[currentFile];
  
  console.log('nextLesson called');
  console.log('Current file:', currentFile);
  console.log('Next lesson file:', nextLessonFile);
  
  if (nextLessonFile) {
    console.log('Navigating to:', nextLessonFile);
    window.location.href = nextLessonFile;
  } else {
    console.log('No next lesson available, navigating to Index Page');
    window.location.href = '../index.html';
  }
}

// Check if there's a next lesson and update button text if needed
function checkNextLessonAvailability(){
  const currentFile = window.location.pathname.split('/').pop();
  const nextLessonBtn = document.getElementById('nextLessonBtn');
  
  // Debug logging
  console.log('Current file:', currentFile);
  console.log('Next lesson available:', LESSON_NAVIGATION[currentFile]);
  console.log('Button element:', nextLessonBtn);
  
  if (nextLessonBtn) {
    // Always keep the button enabled and clickable
    nextLessonBtn.disabled = false;
    
    // Always show "Next Lesson" text and navigate to next lesson
    // If no next lesson exists, it will navigate to Index Page (handled in nextLesson function)
    nextLessonBtn.textContent = nextLessonBtn.getAttribute('data-en') === 'Next Lesson ‚Üí' ? 'Next Lesson ‚Üí' : '‰∏ã‰∏ÄË™≤ ‚Üí';
  }
}

// Bind UI
document.querySelectorAll('[data-mv]').forEach(btn=> btn.addEventListener('click', ()=> addMove(btn.getAttribute('data-mv'))));
document.getElementById('runBtn').addEventListener('click', run);
document.getElementById('undoBtn').addEventListener('click', undo);
document.getElementById('clearBtn').addEventListener('click', clearPlan);
document.getElementById('resetBtn').addEventListener('click', ()=>{ plan=[]; drawBoard(); });
document.getElementById('hintBtn').addEventListener('click', ()=>{ document.getElementById('hint').hidden=false; });
document.getElementById('nextLevelBtn').addEventListener('click', nextLevel);

// Bind Next Lesson button with error handling
const nextLessonBtn = document.getElementById('nextLessonBtn');
if (nextLessonBtn) {
  nextLessonBtn.addEventListener('click', function(e) {
    console.log('Next Lesson button clicked!');
    nextLesson();
  });
} else {
  console.error('Next Lesson button not found!');
}

// Keyboard: arrows add moves, Backspace undo, Enter run
window.addEventListener('keydown', (e)=>{
  if (['ArrowRight','ArrowLeft','ArrowUp','ArrowDown','Backspace','Enter'].includes(e.key)) e.preventDefault();
  if (e.key==='ArrowRight') addMove('Right');
  if (e.key==='ArrowLeft') addMove('Left');
  if (e.key==='ArrowUp') addMove('Up');
  if (e.key==='ArrowDown') addMove('Down');
  if (e.key==='Backspace') undo();
  if (e.key==='Enter') run();
});

// Start
drawBoard();
</script>
</body>
</html>


