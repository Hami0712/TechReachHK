<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TechReach HK - Robot Route ‚Äî Programming</title>
<style>
  :root{
    --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --panel:#ffffff;      
    --ink:#0f172a;        
    --muted:#475569;      
    --accent:#2563eb;     
    --accent-2:#22c55e;   
    --accent-3:#f59e0b;   
    --accent-4:#ef4444;   
    --accent-5:#8b5cf6;   
    --line:#cbd5e1;       
    --chip:#eef2ff;
    --shadow: 0 10px 25px rgba(0,0,0,0.1);
    --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
    --good:#16a34a; 
    --bad:#dc2626;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; min-height:100vh; }
  body{ font-size:18px; line-height:1.55; }
  .wrap{max-width:1200px; margin-inline:auto; padding:24px;}
  header{
    display:flex; align-items:center; gap:20px; margin-bottom:32px; 
    background:rgba(255,255,255,0.95); padding:24px; border-radius:20px; 
    box-shadow:var(--shadow); backdrop-filter:blur(10px);
  }
  header .logo{
    width:60px;height:60px; border-radius:16px; 
    background:linear-gradient(135deg,var(--accent),#60a5fa); 
    display:grid; place-items:center; color:#fff; font-weight:800; font-size:24px;
    box-shadow: 0 8px 16px rgba(37, 99, 235, 0.3);
  }
  h1{font-size:clamp(28px,4vw,42px); margin:0; background:linear-gradient(135deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
  .subtitle{color:var(--muted); margin-top:8px; font-size:18px;}
  
  /* Language toggle */
  .lang-toggle{
    margin-left:auto; display:flex; align-items:center; gap:8px;
    background:rgba(255,255,255,0.1); padding:8px 16px; 
    border-radius:20px; border:1px solid rgba(255,255,255,0.2);
    backdrop-filter:blur(10px); transition:all 0.3s ease;
  }
  .lang-toggle:hover{background:rgba(255,255,255,0.2);}
  .lang-toggle button{
    background:none; border:none; color:var(--ink); font-size:14px; 
    font-weight:600; padding:4px 8px; border-radius:8px; 
    cursor:pointer; transition:all 0.2s ease;
  }
  .lang-toggle button.active{
    background:var(--accent); color:#fff; box-shadow:0 2px 8px rgba(37, 99, 235, 0.3);
  }
  .lang-toggle button:not(.active):hover{
    background:rgba(37, 99, 235, 0.1); color:var(--accent);
  }
  
  /* Navigation buttons - consistent sizing */
  .back-btn, .next-lesson-btn, .back-to-index-btn{
    background:var(--accent); color:#fff; border:none; padding:12px 20px; 
    border-radius:12px; font-weight:600; cursor:pointer; transition:all 0.3s ease;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    min-width: 140px; height: 48px; justify-content: center;
  }
  .back-btn:hover{
    background:#1d4ed8; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
  }
  
  /* Next Lesson button specific styling */
  .next-lesson-btn{
    background:var(--accent-5); 
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }
  .next-lesson-btn:hover{
    background:#7c3aed; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
  }
  
  /* Back to Index button specific styling */
  .back-to-index-btn{
    background:var(--accent-2); 
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
  }
  .back-to-index-btn:hover{
    background:#16a34a; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
  }
  
  main{ max-width:980px; margin:0 auto; padding:16px; }
  .card{ 
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
    backdrop-filter: blur(5px); border:2px solid var(--line); border-radius:16px; 
    padding:20px; margin:12px 0; box-shadow:var(--shadow); transition:all 0.3s ease;
  }
  .card:hover{ transform:translateY(-2px); box-shadow:var(--shadow-hover); }
  .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  button, .btn, select, input[type="number"]{
    font-size:18px; padding:10px 14px; border-radius:10px; border:2px solid #0f172a; background:#fff; color:#0f172a;
  }
  button:hover, .btn:hover{ outline:3px solid var(--accent); cursor:pointer; }
  button:focus, .btn:focus, select:focus, input:focus{ outline:4px solid var(--accent); }
  .hint{ background:#fff; border-left:6px solid var(--accent); padding:10px; border-radius:8px; }
  .good{ color:var(--good); font-weight:700; }
  .bad{ color:var(--bad); font-weight:700; }
  .sr{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
  .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#fff; border-radius:6px; padding:2px 6px; border:1px solid #0f172a; }
  /* Game grid */
  .board{ display:grid; grid-template-columns: repeat(10, 36px); gap:6px; }
  .cell{ width:36px; height:36px; border:2px solid #0f172a; border-radius:6px; display:flex; align-items:center; justify-content:center; background:#fff; }
  .start{ background:#d1fae5; }
  .goal{ background:#fde68a; }
  .wall{ background:#c7d2fe; position:relative; }
  .wall::after{ content:""; position:absolute; inset:6px; border:2px solid #0f172a; border-style:dashed; border-radius:4px; opacity:.8; }
  .block{ background:#fff; border:2px dashed #0f172a; padding:8px; border-radius:10px; min-height:52px; }
  .legend{ display:flex; gap:10px; align-items:center; font-size:16px; }
  .legend .swatch{ width:18px; height:18px; border:2px solid #0f172a; border-radius:4px; display:inline-block; }
  .mt{ margin-top:12px; }
  .sm{ font-size:14px; opacity:.9; }
  /* Animation overlay */
  .boardWrap{ position:relative; display:inline-block; }
  #robot{ position:absolute; top:0; left:0; width:36px; height:36px; display:flex; align-items:center; justify-content:center; pointer-events:none; will-change:transform; transition: transform 220ms ease; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">ü§ñ</div>
      <div>
        <h1 data-en="Robot Route - Programming" data-zh="Ê©üÂô®‰∫∫Ë∑ØÁ∑ö - Á∑®Á®ã">Robot Route - Programming</h1>
        <div class="subtitle" data-en="Write your first programs with commands" data-zh="Áî®Êåá‰ª§Á∑®ÂØ´‰Ω†ÁöÑÁ¨¨‰∏ÄÂÄãÁ®ãÂºè">Write your first programs with commands</div>
      </div>
      <div class="lang-toggle">
        <button class="active" onclick="switchLanguage('en')">EN</button>
        <button onclick="switchLanguage('zh')">ÁπÅ‰∏≠</button>
      </div>
    </header>
    
    <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
      <a href="1. Robot Route - Arrows Only.html" class="back-btn">
        ‚Üê <span data-en="Previous Lesson" data-zh="‰∏ä‰∏ÄË™≤">Previous Lesson</span>
      </a>
      <button id="nextLessonBtn" class="next-lesson-btn" data-en="Next Lesson ‚Üí" data-zh="‰∏ã‰∏ÄË™≤ ‚Üí">Next Lesson ‚Üí</button>
      <button id="backToIndexBtn" class="back-to-index-btn" data-en="Back to All Lessons" data-zh="ËøîÂõûÈ¶ñÈ†Å">Back to All Lessons</button>
    </div>

<main>
  <div class="card">
    <p data-en="<strong>Learn:</strong> <em>Programming</em> ‚Äî write commands to control the robot.<br/><strong>Why it matters:</strong> Programming is giving instructions to computers." data-zh="<strong>Â≠∏ÁøíÔºö</strong> <em>Á∑®Á®ã</em> ‚Äî Á∑®ÂØ´Êåá‰ª§ÊéßÂà∂Ê©üÂô®‰∫∫„ÄÇ<br/><strong>ÁÇ∫‰ªÄÈ∫ºÈáçË¶ÅÔºö</strong> Á∑®Á®ãÂ∞±ÊòØÁµ¶ÈõªËÖ¶‰∏ãÊåá‰ª§„ÄÇ"><strong>Learn:</strong> <em>Programming</em> ‚Äî write commands to control the robot.<br/><strong>Why it matters:</strong> Programming is giving instructions to computers.</p>
  </div>

  <div class="card">
    <div class="row">
      <strong data-en="Level" data-zh="ÈóúÂç°">Level</strong> <span id="lvl">1</span>/8
      <button id="hintBtn" data-en="Hint" data-zh="ÊèêÁ§∫">Hint</button>
      <button id="resetBtn" data-en="Reset Level" data-zh="ÈáçÁΩÆÈóúÂç°">Reset Level</button>
      <button id="runBtn" data-en="Run (from Program)" data-zh="Âü∑Ë°åÔºàÂæûÁ®ãÂºèÔºâ">Run (from Program)</button>
    </div>
    <div id="hint" class="hint mt" hidden data-en="Type Python-style commands below. Press Cmd/Ctrl+Enter or Run to execute." data-zh="Âú®‰∏ãÊñπËº∏ÂÖ•PythonÈ¢®Ê†ºÁöÑÊåá‰ª§„ÄÇÊåâCmd/Ctrl+EnterÊàñÂü∑Ë°åÊåâÈàï‰æÜÈÅãË°å„ÄÇ">
      Type Python-style commands below. Press Cmd/Ctrl+Enter or Run to execute.
    </div>

    <div class="row mt" style="align-items:flex-start">
      <div>
        <div class="boardWrap">
          <div id="board" class="board" role="grid" aria-label="game board"></div>
          <div id="robot" aria-hidden="true">ü§ñ</div>
        </div>
        <div class="legend mt" aria-hidden="true">
          <span class="swatch" style="background:#d1fae5"></span> <span data-en="Start" data-zh="Ëµ∑Èªû">Start</span>
          <span class="swatch" style="background:#fde68a"></span> <span data-en="Goal" data-zh="ÁõÆÊ®ô">Goal</span>
          <span class="swatch" style="background:#c7d2fe"></span> <span data-en="Wall" data-zh="ÁâÜÂ£Å">Wall</span>
        </div>
      </div>
      <div style="flex:1">
        <div><strong data-en="Your steps (from code):" data-zh="‰Ω†ÁöÑÊ≠•È©üÔºàÂæûÁ®ãÂºèÁ¢ºÔºâÔºö">Your steps (from code):</strong></div>
        <div id="block" class="block" aria-live="polite" data-en="(empty)" data-zh="(Á©∫ÁôΩ)">(empty)</div>
        <p id="tip" class="sm mt" data-en="Type Python-style commands below. Press <span class='kbd'>Cmd/Ctrl+Enter</span> to run." data-zh="Âú®‰∏ãÊñπËº∏ÂÖ•PythonÈ¢®Ê†ºÁöÑÊåá‰ª§„ÄÇÊåâ<span class='kbd'>Cmd/Ctrl+Enter</span>‰æÜÈÅãË°å„ÄÇ">Type Python-style commands below. Press <span class="kbd">Cmd/Ctrl+Enter</span> to run.</p>
        <div id="feedback" class="mt" aria-live="polite"></div>

        <div class="mt" id="codeSection">
          <div><strong data-en="Write your program:" data-zh="Á∑®ÂØ´‰Ω†ÁöÑÁ®ãÂºèÔºö">Write your program:</strong></div>
          <div class="block" style="padding:0">
            <textarea id="code" style="width:100%; height:200px; border:0; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:16px;" aria-label="code editor" data-en="Examples (Python-style):
right(3)
up()
left(2)
down(5)" data-zh="ÁØÑ‰æãÔºàPythonÈ¢®Ê†ºÔºâÔºö
right(3)
up()
left(2)
down(5)" placeholder="Examples (Python-style):
right(3)
up()
left(2)
down(5)"></textarea>
          </div>
          <div class="row mt">
            <button id="runCodeBtn" data-en="Run Program" data-zh="Âü∑Ë°åÁ®ãÂºè">Run Program</button>
            <button id="loadStepsBtn" data-en="Load Steps Only" data-zh="ÂÉÖËºâÂÖ•Ê≠•È©ü">Load Steps Only</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
  </div>

<script>
// Language switching functionality
function switchLanguage(lang) {
  // Update button states
  document.querySelectorAll('.lang-toggle button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Update all elements with data attributes
  document.querySelectorAll('[data-en][data-zh]').forEach(element => {
    if (lang === 'zh') {
      element.innerHTML = element.getAttribute('data-zh');
    } else {
      element.innerHTML = element.getAttribute('data-en');
    }
  });
  
  // Update HTML lang attribute
  document.documentElement.lang = lang === 'zh' ? 'zh-Hant' : 'en';
  
  // Store language preference
  localStorage.setItem('preferredLanguage', lang);
}

// Load saved language preference on page load
document.addEventListener('DOMContentLoaded', function() {
  const savedLang = localStorage.getItem('preferredLanguage') || 'en';
  if (savedLang === 'zh') {
    // Update button states
    document.querySelectorAll('.lang-toggle button').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector('.lang-toggle button[onclick="switchLanguage(\'zh\')"]').classList.add('active');
    
    // Update content
    document.querySelectorAll('[data-en][data-zh]').forEach(element => {
      element.innerHTML = element.getAttribute('data-zh');
    });
    document.documentElement.lang = 'zh-Hant';
  }
  
  // Initialize navigation buttons
  initializeNavigationButtons();
});

// Navigation functions
function nextLesson(){
  console.log('Next Lesson button clicked!');
  window.location.href = '3. Debugging Robot Route.html';
}

function backToIndex(){
  console.log('Back to Index button clicked!');
  window.location.href = '../index.html';
}

function initializeNavigationButtons(){
  // Bind Next Lesson button
  const nextLessonBtn = document.getElementById('nextLessonBtn');
  if (nextLessonBtn) {
    nextLessonBtn.addEventListener('click', nextLesson);
  }
  
  // Bind Back to Index button
  const backToIndexBtn = document.getElementById('backToIndexBtn');
  if (backToIndexBtn) {
    backToIndexBtn.addEventListener('click', backToIndex);
  }
}

</script>
<script>
/* =====================
   Levels
   Each level has: grid size (10x10 fixed), start [x,y], goal [x,y], walls as array of [x,y]
   (0,0) is top-left
===================== */
const LEVELS = [
  { start:[0,9], goal:[3,9], walls:[] },                              // 1: straight line
  { start:[0,9], goal:[5,9], walls:[[2,9],[3,9]] },                   // 2: small detour
  { start:[0,9], goal:[7,7], walls:[[1,9],[1,8],[2,8],[3,8]] },       // 3: corner block
  { start:[0,9], goal:[9,6], walls:[[2,9],[3,9],[4,9],[5,9],[6,9]] }, // 4: must go up then right
  { start:[2,8], goal:[7,2], walls:[[3,8],[4,8],[5,8],[6,8],[7,8],[8,8],[8,7],[8,6],[7,6],[6,6],[5,6],[4,6],[3,6],[2,6],[1,6],[1,5],[2,5],[3,5],[4,5],[5,5],[6,5],[7,5],[8,5],[8,4],[7,4],[6,4],[5,4],[4,4],[3,4],[2,4],[1,4],[1,3],[2,3],[3,3],[4,3],[5,3],[6,3],[7,3]] }, // 5: complex maze - guaranteed path
  { start:[1,7], goal:[8,1], walls:[[2,7],[3,7],[4,7],[5,7],[6,7],[7,7],[8,7],[8,6],[7,6],[6,6],[5,6],[4,6],[3,6],[2,6],[1,6],[1,5],[2,5],[3,5],[4,5],[5,5],[6,5],[7,5],[8,5],[8,4],[7,4],[6,4],[5,4],[4,4],[3,4],[2,4],[1,4],[1,3],[2,3],[3,3],[4,3],[5,3],[6,3],[7,3],[8,3],[8,2],[7,2],[6,2],[5,2],[4,2],[3,2],[2,2]] }, // 6: expert maze - guaranteed path
  { start:[3,9], goal:[6,0], walls:[[0,9],[1,9],[2,9],[4,9],[5,9],[6,9],[7,9],[8,9],[9,9],       
    [0,0],[1,0],[2,0],[3,0],[4,0],[5,0],[7,0],[8,0],[9,0],        
    [0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[0,8],              
    [9,1],[9,2],[9,3],[9,4],[9,5],[9,6],[9,7],[9,8]] }, // 7: master maze - solvable
    {
  "start": [0, 6],
  "goal": [9, 3],
  "walls": [
    [1,6],[2,6],[3,6],[4,6],[5,6],[6,6],[7,6],[8,6],[9,6],
    [1,5],[2,5],[3,5],[4,5],[5,5],[6,5],[7,5],[8,5],[9,5],
    [1,4],[2,4],[3,4],[4,4],[5,4],[6,4],[7,4],[8,4],[9,4],
    /* (intentionally no walls on y=3 to keep the corridor open) */
    [0,2],[1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2],[8,2],[9,2],
    [0,1],[1,1],[2,1],[3,1],[4,1],[5,1],[6,1],[7,1],[8,1],[9,1],
    [0,0],[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0],[9,0]
  ]
}
];

let level = 0;
let plan = []; // sequence of moves

function drawBoard() {
  const L = LEVELS[level];
  const b = document.getElementById('board');
  b.innerHTML = "";
  // Reset robot overlay position
  const robot = document.getElementById('robot');
  robot.style.transform = `translate(${L.start[0]*(36+6)}px, ${L.start[1]*(36+6)}px)`;
  for (let y=0; y<10; y++) {
    for (let x=0; x<10; x++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      if (L.walls.some(w=> w[0]===x && w[1]===y)) cell.classList.add('wall');
      if (x===L.start[0] && y===L.start[1]) { cell.classList.add('start'); }
      if (x===L.goal[0] && y===L.goal[1])  { cell.classList.add('goal');  cell.textContent = '‚òÖ'; }
      b.appendChild(cell);
    }
  }
  document.getElementById('lvl').textContent = (level+1);
  setFeedback("");
  renderPlan();
  document.getElementById('hint').hidden = true;
}

function renderPlan(){
  const out = plan.length ? plan.join(" ‚Üí ") : "(empty)";
  document.getElementById('block').textContent = out;
}

function setFeedback(msg, cls=''){
  const el = document.getElementById('feedback');
  el.className = 'mt ' + cls;
  el.textContent = msg;
}

function applyMove(mv, pos){
  const p = {x:pos.x, y:pos.y};
  if (mv==='Right') p.x++;
  if (mv==='Left') p.x--;
  if (mv==='Up') p.y--;
  if (mv==='Down') p.y++;
  return p;
}

function inBounds(p){ return p.x>=0 && p.x<10 && p.y>=0 && p.y<10; }
function isWall(p){ return LEVELS[level].walls.some(w=> w[0]===p.x && w[1]===p.y); }

let running = false;
function setControlsDisabled(disabled){
  document.querySelectorAll('button').forEach(el=>{ el.disabled = disabled; });
}

async function run(){
  const L = LEVELS[level];
  let pos = {x:L.start[0], y:L.start[1]};
  if (plan.length===0){
    setFeedback("Write some commands first.", "bad");
    return;
  }
  if (running) return;
  running = true;
  setControlsDisabled(true);
  setFeedback("");
  const robot = document.getElementById('robot');
  const stepPx = 36+6; // cell + gap
  for (let i=0;i<plan.length;i++){
    const next = applyMove(plan[i], pos);
    if (!inBounds(next)){
      setFeedback("Out of the board at step "+(i+1)+". Try a different way.", "bad");
      break;
    }
    if (isWall(next)){
      setFeedback("Hit a wall at step "+(i+1)+". Try going around.", "bad");
      break;
    }
    pos = next;
    robot.style.transform = `translate(${pos.x*stepPx}px, ${pos.y*stepPx}px)`;
    await new Promise(r=> setTimeout(r, 230));
  }
  // Evaluate end state
  if (pos.x===L.goal[0] && pos.y===L.goal[1]){
    if (level < LEVELS.length-1){
      setFeedback("Great path! Next level‚Ä¶", "good");
      setTimeout(()=>{ level++; plan=[]; drawBoard(); }, 900);
    } else {
      setFeedback("You finished all levels! üéâ", "good");
    }
  } else if (plan.length>0) {
    const dx = L.goal[0]-pos.x, dy = L.goal[1]-pos.y;
    let tip = "Not there yet. ";
    if (Math.abs(dx)+Math.abs(dy) <= 4){ tip += "You are close. "; }
    if (dx>0) tip += "Need more Right. ";
    if (dx<0) tip += "Need more Left. ";
    if (dy>0) tip += "Need more Down. ";
    if (dy<0) tip += "Need more Up. ";
    setFeedback(tip, "bad");
  }
  running = false;
  setControlsDisabled(false);
}

// =====================
// Python-style command language
// =====================
const DIRS = { right:'Right', left:'Left', up:'Up', down:'Down' };

function splitSemicolonsPreserve(lines){
  const out = [];
  lines.forEach(line=>{
    const parts = line.split(';').map(s=> s.trim()).filter(Boolean);
    out.push(...parts);
  });
  return out;
}

function parseSimpleCommand(cmd){
  // direction(n) or direction()
  const mm = cmd.match(/^(right|left|up|down)\s*\(\s*(\d+)?\s*\)$/i);
  if (mm){
    const dir = DIRS[mm[1].toLowerCase()];
    const n = mm[2] ? parseInt(mm[2],10) : 1;
    return Array(n).fill(dir);
  }
  // also allow legacy: move('dir', n)
  const m2 = cmd.match(/^move\s*\(\s*['\"](right|left|up|down)['\"]\s*,\s*(\d+)\s*\)$/i);
  if (m2){
    const dir = DIRS[m2[1].toLowerCase()];
    const n = parseInt(m2[2],10);
    return Array(n).fill(dir);
  }
  return null;
}

function compileProgram(src){
  const rawLines = src.replace(/\r/g,'').split("\n").map(s=> s.trim());
  const lines = rawLines.filter(Boolean);
  let i = 0;

  function parseBlock(){
    let steps = [];
    while (i < lines.length){
      let line = lines[i];
      if (/^end$/i.test(line)){
        i++; // consume 'end'
        break;
      }
      const rep = line.match(/^repeat\s+(\d+)\s*:\s*$/i);
      if (rep){
        i++; // consume repeat line
        const times = parseInt(rep[1],10);
        const inner = parseBlock();
        for (let t=0;t<times;t++){ steps.push(...inner); }
        continue;
      }
      // allow same-line simple commands split by semicolons
      const parts = splitSemicolonsPreserve([line]);
      for (const part of parts){
        const simple = parseSimpleCommand(part);
        if (simple){ steps.push(...simple); }
        else if (/^repeat\s+\d+\s*:\s*end$/i.test(part)){
          continue;
        } else {
          throw new Error("Unknown command: " + part);
        }
      }
      i++;
    }
    return steps;
  }

  i = 0;
  const result = [];
  while (i < lines.length){
    const line = lines[i];
    const rep = line.match(/^repeat\s+(\d+)\s*:\s*$/i);
    if (rep){
      i++; // consume repeat
      const times = parseInt(rep[1],10);
      const inner = parseBlock();
      for (let t=0;t<times;t++){ result.push(...inner); }
      continue;
    }
    const parts = splitSemicolonsPreserve([line]);
    for (const part of parts){
      const simple = parseSimpleCommand(part);
      if (simple){ result.push(...simple); }
      else if (/^end$/i.test(part)){
        throw new Error("Unexpected 'end' without a matching 'repeat'.");
      } else {
        throw new Error("Unknown command: " + part);
      }
    }
    i++;
  }
  return result;
}

function loadFromCode(){
  try{
    const code = document.getElementById('code').value;
    const steps = compileProgram(code);
    plan = steps;
    renderPlan();
    setFeedback("Loaded " + steps.length + " steps from code.", "good");
  } catch(err){
    setFeedback(err.message, 'bad');
  }
}

async function runFromCode(){
  try{
    const code = document.getElementById('code').value;
    plan = compileProgram(code);
    renderPlan();
    await run();
  } catch(err){
    setFeedback(err.message, 'bad');
  }
}

// Bind UI
document.getElementById('runBtn').addEventListener('click', runFromCode);
document.getElementById('runCodeBtn').addEventListener('click', runFromCode);
document.getElementById('loadStepsBtn').addEventListener('click', loadFromCode);
document.getElementById('resetBtn').addEventListener('click', ()=>{ plan=[]; drawBoard(); });
document.getElementById('hintBtn').addEventListener('click', ()=>{ document.getElementById('hint').hidden=false; });

// Keyboard: allow editing; Cmd/Ctrl+Enter to run
window.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)){
    e.preventDefault();
    runFromCode();
  }
});

// Start
drawBoard();
</script>
</body>
</html>


