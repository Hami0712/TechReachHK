<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Smart Home Game ‚Äî Learn Programming Logic</title>
<style>
  :root{
    --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --panel:#ffffff;      
    --ink:#0f172a;        
    --muted:#475569;      
    --accent:#2563eb;     
    --accent-2:#22c55e;   
    --accent-3:#f59e0b;   
    --accent-4:#ef4444;   
    --accent-5:#8b5cf6;   
    --line:#cbd5e1;       
    --chip:#eef2ff;
    --shadow: 0 10px 25px rgba(0,0,0,0.1);
    --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
    --good:#16a34a; 
    --bad:#dc2626;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; min-height:100vh; }
  body{ font-size:18px; line-height:1.55; }
  .wrap{max-width:1200px; margin-inline:auto; padding:24px;}
  header{
    display:flex; align-items:center; gap:20px; margin-bottom:32px; 
    background:rgba(255,255,255,0.95); padding:24px; border-radius:20px; 
    box-shadow:var(--shadow); backdrop-filter:blur(10px);
  }
  header .logo{
    width:60px;height:60px; border-radius:16px; 
    background:linear-gradient(135deg,var(--accent),#60a5fa); 
    display:grid; place-items:center; color:#fff; font-weight:800; font-size:24px;
    box-shadow: 0 8px 16px rgba(37, 99, 235, 0.3);
  }
  h1{font-size:clamp(28px,4vw,42px); margin:0; background:linear-gradient(135deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
  .subtitle{color:var(--muted); margin-top:8px; font-size:18px;}
  
  /* Language toggle */
  .lang-toggle{
    margin-left:auto; display:flex; align-items:center; gap:8px;
    background:rgba(255,255,255,0.1); padding:8px 16px; 
    border-radius:20px; border:1px solid rgba(255,255,255,0.2);
    backdrop-filter:blur(10px); transition:all 0.3s ease;
  }
  .lang-toggle:hover{background:rgba(255,255,255,0.2);}
  .lang-toggle button{
    background:none; border:none; color:var(--ink); font-size:14px; 
    font-weight:600; padding:4px 8px; border-radius:8px; 
    cursor:pointer; transition:all 0.2s ease;
  }
  .lang-toggle button.active{
    background:var(--accent); color:#fff; box-shadow:0 2px 8px rgba(37, 99, 235, 0.3);
  }
  .lang-toggle button:not(.active):hover{
    background:rgba(37, 99, 235, 0.1); color:var(--accent);
  }
  
  /* Navigation buttons - consistent sizing */
  .back-btn, .next-lesson-btn, .back-to-index-btn{
    background:var(--accent); color:#fff; border:none; padding:12px 20px; 
    border-radius:12px; font-weight:600; cursor:pointer; transition:all 0.3s ease;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    min-width: 140px; height: 48px; justify-content: center;
  }
  .back-btn:hover{
    background:#1d4ed8; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
  }
  
  /* Next Lesson button specific styling */
  .next-lesson-btn{
    background:var(--accent-5); 
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }
  .next-lesson-btn:hover{
    background:#7c3aed; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
  }
  
  /* Back to All Lessons button specific styling */
  .back-to-index-btn{
    background:var(--accent-2); 
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
  }
  .back-to-index-btn:hover{
    background:#16a34a; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
  }
  
  main{ max-width:980px; margin:0 auto; padding:16px; }
  .card{ 
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
    backdrop-filter: blur(5px); border:2px solid var(--line); border-radius:16px; 
    padding:20px; margin:16px 0; box-shadow:var(--shadow); transition:all 0.3s ease;
  }
  .card:hover{ transform:translateY(-2px); box-shadow:var(--shadow-hover); }
  .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
  button{
    font-size:18px; padding:12px 20px; border-radius:12px; border:2px solid #1e40af; background:#fff; color:#1e40af; font-weight:600;
  }
  button:hover{ background:#1e40af; color:#fff; cursor:pointer; transform: translateY(-2px); }
  button:focus{ outline:4px solid #3b82f6; }
  .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#fff; border-radius:6px; padding:4px 8px; border:1px solid #1e40af; font-weight:600; }
  
  /* Smart Home Layout */
  .home-layout{ 
    display:grid; 
    grid-template-columns: 1fr 1fr; 
    gap:20px; 
    background:#fff; 
    border:3px solid #1e40af; 
    border-radius:16px; 
    padding:20px;
    position:relative;
    min-height: 420px;
  }
  
  .room{ 
    background:#f8fafc; 
    border:2px solid #cbd5e1; 
    border-radius:12px; 
    padding:16px; 
    position:relative;
    min-height: 200px;
  }
  
  .room-title{ 
    font-size: 18px; 
    font-weight: bold; 
    color: #1e40af; 
    margin-bottom: 12px; 
    text-align: center;
  }
  
  .device{ 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    background: #fff; 
    border: 2px solid #cbd5e1; 
    border-radius: 8px; 
    padding: 12px; 
    margin: 8px 0;
    transition: all 0.3s ease;
  }
  
  .device.on{ 
    background: #dcfce7; 
    border-color: #16a34a; 
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
  }
  
  .device-name{ 
    font-weight: 600; 
    color: #1e293b; 
    font-size: 16px;
  }
  
  .device-status{ 
    font-size: 24px; 
    transition: all 0.3s ease;
  }
  
  .device.off .device-status{ opacity: 0.3; }
  .device.on .device-status{ opacity: 1; }
  
  /* Robot */
  #robot{ 
    position:absolute; 
    top:20px; right:20px; 
    width:60px; height:60px; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    pointer-events:none; 
    will-change:transform; 
    transition: transform 450ms ease;
    z-index:10;
    font-size: 32px;
    background: rgba(59, 130, 246, 0.1);
    border: 3px solid #3b82f6;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  
  .muted{ opacity:.9; font-size:14px; }
  .good{ color:var(--good); font-weight:700; }
  .bad{ color:var(--bad); font-weight:700; }
  .warn{ color:var(--warn); font-weight:700; }
  
  /* Mission display */
  .mission{ 
    background:#fef3c7; 
    border:3px solid #f59e0b; 
    border-radius:12px; 
    padding:16px; 
    font-size:18px;
    margin:16px 0;
    text-align: center;
  }
  .mission .title{ color:#92400e; font-weight:bold; margin-bottom:8px; font-size:20px; }
  .mission .goal{ color:#1e293b; }
  
  /* Code editor */
  .code-editor{ background:#1e293b; border-radius:12px; overflow:hidden; }
  .code-header{ background:#334155; padding:12px 16px; color:#fff; font-weight:600; }
  .code-textarea{ width:100%; height:220px; border:0; padding:16px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:16px; background:#1e293b; color:#e2e8f0; resize:vertical; }
  .code-help{ background:#334155; padding:12px 16px; color:#94a3b8; font-size:14px; }
  
  /* Sensor display */
  .sensor { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db; }
  .sensor-name { font-weight: 600; color: #374151; }
  .sensor-status { font-weight: 700; color: #16a34a; }
  .sensor-status.warning { color: #dc2626; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">üè†</div>
      <div>
        <h1 data-en="Smart Home AND OR NOT" data-zh="Êô∫ËÉΩÂÆ∂Â±Ö AND OR NOT">Smart Home AND OR NOT</h1>
        <div class="subtitle" data-en="Program your smart home with real-life scenarios using logic gates" data-zh="‰ΩøÁî®ÈÇèËºØÈñòÁÇ∫Êô∫ËÉΩÂÆ∂Â±ÖÁ∑®Á®ãÁúüÂØ¶Â†¥ÊôØ">Program your smart home with real-life scenarios using logic gates</div>
      </div>
      <div class="lang-toggle">
        <button class="active" onclick="switchLanguage('en')">EN</button>
        <button onclick="switchLanguage('zh')">ÁπÅ‰∏≠</button>
      </div>
    </header>
    
    <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
      <a href="8. AND OR NOT Logic.html" class="back-btn">
        ‚Üê <span data-en="Previous Lesson" data-zh="‰∏ä‰∏ÄË™≤">Previous Lesson</span>
      </a>
      <button id="nextLessonBtn" class="next-lesson-btn" data-en="Next Lesson ‚Üí" data-zh="‰∏ã‰∏ÄË™≤ ‚Üí">Next Lesson ‚Üí</button>
      <button id="backToIndexBtn" class="back-to-index-btn" data-en="Back to All Lessons" data-zh="ËøîÂõûÈ¶ñÈ†Å">Back to All Lessons</button>
    </div>

    <main>
  <!-- Mission Display -->
  <div class="mission">
    <div class="title">üéØ Your Mission</div>
    <div class="goal" id="missionText">Turn on the air conditioner when temperature is high and motion is detected!</div>
  </div>

  <!-- Sensor Status -->
  <div class="card" style="background: #f0fdf4; border: 2px solid #16a34a;">
    <h3 style="margin: 0 0 12px 0; color: #166534;">üìä Smart Home Sensors</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 14px;">
      <div class="sensor" id="motion-sensor">
        <span class="sensor-name">üö∂ Motion Detected:</span>
        <span class="sensor-status" id="motion-status">No</span>
      </div>
      <div class="sensor" id="temp-sensor">
        <span class="sensor-name">üå°Ô∏è Temperature:</span>
        <span class="sensor-status" id="temp-status">Normal</span>
      </div>
      <div class="sensor" id="time-sensor">
        <span class="sensor-name">üïê Time:</span>
        <span class="sensor-status" id="time-status">Day</span>
      </div>
      <div class="sensor" id="smoke-sensor">
        <span class="sensor-name">üí® Smoke:</span>
        <span class="sensor-status" id="smoke-status">Clear</span>
      </div>
    </div>
  </div>

  <!-- Smart Home Layout -->
  <div class="card">
    <div class="home-layout">
      <div id="robot">ü§ñ</div>
      
      <!-- Living Room -->
      <div class="room">
        <div class="room-title">üè† Living Room</div>
        <div class="device" id="living-room-light">
          <div class="device-name">üí° Living Room Light</div>
          <div class="device-status">üí°</div>
        </div>
        <div class="device" id="tv">
          <div class="device-name">üì∫ TV</div>
          <div class="device-status">üì∫</div>
        </div>
        <div class="device" id="air-conditioner">
          <div class="device-name">‚ùÑÔ∏è Air Conditioner</div>
          <div class="device-status">‚ùÑÔ∏è</div>
        </div>
        <div class="device" id="smart-blinds">
          <div class="device-name">ü™ü Smart Blinds</div>
          <div class="device-status">ü™ü</div>
        </div>
      </div>
      
      <!-- Kitchen -->
      <div class="room">
        <div class="room-title">üç≥ Kitchen</div>
        <div class="device" id="kitchen-light">
          <div class="device-name">üí° Kitchen Light</div>
          <div class="device-status">üí°</div>
        </div>
        <div class="device" id="microwave">
          <div class="device-name">üî• Microwave</div>
          <div class="device-status">üî•</div>
        </div>
        <div class="device" id="stove">
          <div class="device-name">üî• Stove</div>
          <div class="device-status">üî•</div>
        </div>
        <div class="device" id="coffee-machine">
          <div class="device-name">‚òï Coffee Machine</div>
          <div class="device-status">‚òï</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="card">
    <div class="row">
      <button id="runBtn">‚ñ∂Ô∏è Run Program</button>
      <button id="resetBtn">üîÑ Reset</button>
      <button id="hintBtn">üí° Hint</button>
    </div>
    <p id="feedback" class="muted"></p>
    <div id="hint" class="muted" style="display:none;"></div>
  </div>

  <!-- Code Editor -->
  <div class="card">
    <div class="code-editor">
      <div class="code-header">ü§ñ Write Your Smart Home Program</div>
      <textarea id="code" class="code-textarea" placeholder="// Type your commands here...
// Example:
// if_both('temperature-high','motion-detected'):
//   turn_on('air-conditioner')"></textarea>
      <div class="code-help">
        <strong>Commands:</strong> <span class="kbd">turn_on('device')</span> ‚Ä¢ <span class="kbd">turn_off('device')</span> ‚Ä¢ <span class="kbd">if_both('a','b'):</span> ‚Ä¢ <span class="kbd">if_any('a','b'):</span> ‚Ä¢ <span class="kbd">if_not('a'):</span><br>
        Use 2-space indentation for actions. Cmd/Ctrl+Enter to run.
      </div>
    </div>
  </div>
</main>

<script>
let running = false;
let lvl = 0;

// State
let deviceState = { 
  // Doors & Windows
  'front-door': false, 
  'window': false,
  'garage-door': false,
  
  // Lights
  'living-room-light': false, 
  'kitchen-light': false,
  'garage-light': false,
  
  // Appliances
  'tv': false, 
  'microwave': false,
  'air-conditioner': false,
  'ceiling-fan': false,
  'coffee-machine': false,
  'stove': false,
  
  // Smart Features
  'smart-blinds': false,
  'alarm': false,
  'doorbell': false,
  'sprinklers': false,
  
  // Sensors (read-only for player)
  'motion-detected': false,
  'temperature-high': false,
  'smoke-detected': false,
  'time-evening': false,
  'time-morning': false,
  'weekday': false,
  'rain-forecast': false
};

// Levels (now with clear win conditions: must_on / must_off)
const LEVELS = [
  {
    title: "Smart Cooling",
    goal: "Turn on AC when temperature is high AND motion is detected",
    mission: "Turn on the air conditioner when the temperature is above 27¬∞C AND motion is detected in the living room!",
    hint: "Use if_both('temperature-high','motion-detected') then turn_on('air-conditioner')",
    starter: `if_both('temperature-high', 'motion-detected'):
  turn_on('air-conditioner')`,
    must_on: ['air-conditioner'],
    sensors: { 'temperature-high': true, 'motion-detected': true }
  },
  {
    title: "Movie Mode Lighting", 
    goal: "Turn on living room light when TV is ON AND it's evening",
    mission: "Turn on the living room light when the TV is ON AND it's after 7:00 PM.",
    hint: "First turn on the TV, then check both the TV and time-evening.",
    starter: `turn_on('tv')
if_both('tv', 'time-evening'):
  turn_on('living-room-light')`,
    must_on: ['living-room-light'],
    sensors: { 'time-evening': true }
  },
  {
    title: "Energy Saving Mode",
    goal: "Turn off all lights when NO motion AND all doors/windows closed",
    mission: "Turn off both lights when there's no motion and doors/windows are closed.",
    hint: "Nest conditions: if_not('motion-detected'): then if_not('front-door'): then if_not('window'): turn_off(...)",
    starter: `if_not('motion-detected'):
  if_not('front-door'):
    if_not('window'):
      turn_off('living-room-light')
      turn_off('kitchen-light')`,
    must_off: ['living-room-light', 'kitchen-light'],
    sensors: { 'motion-detected': false, 'front-door': false, 'window': false }
  },
  {
    title: "Morning Routine",
    goal: "Open blinds and start coffee when morning AND weekday AND motion",
    mission: "Open smart blinds and start coffee at 6:30 AM on a weekday when motion is detected.",
    hint: "Combine AND by nesting if_both blocks.",
    starter: `if_both('time-morning', 'weekday'):
  if_both('motion-detected', 'motion-detected'):
    turn_on('smart-blinds')
    turn_on('coffee-machine')`,
    must_on: ['smart-blinds','coffee-machine'],
    sensors: { 'time-morning': true, 'weekday': true, 'motion-detected': true }
  },
  {
    title: "Security Alert",
    goal: "Turn on alarm when door opens AND NO motion",
    mission: "If a door opens and there is no motion, turn on the alarm.",
    hint: "Use if_not('motion-detected') with if_any('front-door','garage-door').",
    starter: `turn_on('front-door')
if_not('motion-detected'):
  if_any('front-door', 'garage-door'):
    turn_on('alarm')`,
    must_on: ['alarm'],
    sensors: { 'motion-detected': false }
  },
  {
    title: "Smart Fan Control",
    goal: "Turn on fan when temperature high AND window open AND AC not running",
    mission: "Turn on the ceiling fan when it's hot and the window is open, but AC is NOT running.",
    hint: "Chain with if_both(...) and then if_not('air-conditioner').",
    starter: `turn_on('window')
if_both('temperature-high', 'window'):
  if_not('air-conditioner'):
    turn_on('ceiling-fan')`,
    must_on: ['ceiling-fan'],
    sensors: { 'temperature-high': true }
  },
  {
    title: "Garage Lights",
    goal: "Turn on garage light when garage door opens OR motion detected",
    mission: "Either event should turn the garage light on.",
    hint: "Use if_any('garage-door','motion-detected'): turn_on('garage-light')",
    starter: `if_any('garage-door', 'motion-detected'):
  turn_on('garage-light')`,
    must_on: ['garage-light'],
    sensors: { 'motion-detected': true }
  },
  {
    title: "Do Not Disturb Mode",
    goal: "Mute doorbell at night when TV is NOT on",
    mission: "Between 10PM‚Äì6AM, mute the doorbell if the TV is off.",
    hint: "Check time-evening, then if_not('tv'): turn_off('doorbell')",
    starter: `if_both('time-evening', 'time-evening'):
  if_not('tv'):
    turn_off('doorbell')`,
    must_off: ['doorbell'],
    sensors: { 'time-evening': true }
  },
  {
    title: "Smart Sprinklers",
    goal: "Activate sprinklers when morning AND weekday AND no rain",
    mission: "Water the garden on weekday mornings if no rain is forecast.",
    hint: "if_both('time-morning','weekday') then if_not('rain-forecast') then turn_on('sprinklers')",
    starter: `if_both('time-morning', 'weekday'):
  if_not('rain-forecast'):
    turn_on('sprinklers')`,
    must_on: ['sprinklers'],
    sensors: { 'time-morning': true, 'weekday': true, 'rain-forecast': false }
  },
  {
    title: "Cooking Safety",
    goal: "Turn off stove AND turn on alarm when smoke detected AND stove on",
    mission: "When smoke is detected and the stove is on, turn the stove off and enable the alarm.",
    hint: "if_both('smoke-detected','stove'): turn_off('stove'); turn_on('alarm')",
    starter: `turn_on('stove')
if_both('smoke-detected', 'stove'):
  turn_off('stove')
  turn_on('alarm')`,
    must_on: ['alarm'],
    must_off: ['stove'],
    sensors: { 'smoke-detected': true }
  }
];

function currentLevel(){ return LEVELS[lvl]; }

function setFeedback(msg, cls){
  const el = document.getElementById('feedback');
  el.className = cls ? cls : 'muted';
  el.textContent = msg;
}

function updateSensorDisplay() {
  const motionStatus = document.getElementById('motion-status');
  if (motionStatus) {
    motionStatus.textContent = deviceState['motion-detected'] ? 'Yes' : 'No';
    motionStatus.className = deviceState['motion-detected'] ? 'sensor-status warning' : 'sensor-status';
  }
  const tempStatus = document.getElementById('temp-status');
  if (tempStatus) {
    tempStatus.textContent = deviceState['temperature-high'] ? 'High (>27¬∞C)' : 'Normal';
    tempStatus.className = deviceState['temperature-high'] ? 'sensor-status warning' : 'sensor-status';
  }
  const timeStatus = document.getElementById('time-status');
  if (timeStatus) {
    if (deviceState['time-evening']) timeStatus.textContent = 'Evening (7PM+)';
    else if (deviceState['time-morning']) timeStatus.textContent = 'Morning (6:30AM)';
    else timeStatus.textContent = 'Day';
    timeStatus.className = (deviceState['time-evening'] || deviceState['time-morning']) ? 'sensor-status warning' : 'sensor-status';
  }
  const smokeStatus = document.getElementById('smoke-status');
  if (smokeStatus) {
    smokeStatus.textContent = deviceState['smoke-detected'] ? 'Smoke Detected!' : 'Clear';
    smokeStatus.className = deviceState['smoke-detected'] ? 'sensor-status warning' : 'sensor-status';
  }
}

function updateDevice(deviceId, isOn) {
  deviceState[deviceId] = isOn;
  const element = document.getElementById(deviceId);
  if (element) {
    element.classList.toggle('on', !!isOn);
  }
}

// API available to the "language"
function turn_on(deviceId) { updateDevice(deviceId, true); }
function turn_off(deviceId) { updateDevice(deviceId, false); }
function if_both(a,b){ return !!deviceState[a] && !!deviceState[b]; }
function if_any(a,b){ return !!deviceState[a] || !!deviceState[b]; }
function if_not(a){ return !deviceState[a]; }

// Safer, nested, indentation-based parser ‚Üí AST
function parseProgram(src){
  const lines = src.split('\n').map((raw, idx)=>{
    const m = raw.match(/^(\s*)(.*)$/); const indentStr = m[1] || ''; const content = m[2] || '';
    return { raw, idx: idx+1, indent: Math.floor(indentStr.replace(/\t/g,'  ').length / 2), content: content.trim() };
  }).filter(l => l.content && !l.content.startsWith('//'));

  const root = { type:'block', body:[] };
  const stack = [{ indent:-1, node:root }];

  function pushNode(node, indent){
    while(stack.length && indent <= stack[stack.length-1].indent){ stack.pop(); }
    const parent = stack[stack.length-1].node;
    parent.body.push(node);
    if(node.type==='if') stack.push({ indent, node });
  }

  for(const line of lines){
    const {indent, content, idx} = line; let m;
    if(m = content.match(/^turn_on\(\s*['"]([^'\"]+)['"]\s*\)$/)){
      pushNode({type:'action', op:'on', device:m[1]}, indent); continue;
    }
    if(m = content.match(/^turn_off\(\s*['"]([^'\"]+)['"]\s*\)$/)){
      pushNode({type:'action', op:'off', device:m[1]}, indent); continue;
    }
    if(m = content.match(/^if_both\(\s*['"]([^'\"]+)['"]\s*,\s*['"]([^'\"]+)['"]\s*\)\s*:\s*$/)){
      pushNode({type:'if', kind:'both', a:m[1], b:m[2], body:[]}, indent); continue;
    }
    if(m = content.match(/^if_any\(\s*['"]([^'\"]+)['"]\s*,\s*['"]([^'\"]+)['"]\s*\)\s*:\s*$/)){
      pushNode({type:'if', kind:'any', a:m[1], b:m[2], body:[]}, indent); continue;
    }
    if(m = content.match(/^if_not\(\s*['"]([^'\"]+)['"]\s*\)\s*:\s*$/)){
      pushNode({type:'if', kind:'not', a:m[1], body:[]}, indent); continue;
    }
    throw new Error(`Unknown command on line ${idx}: ${content}`);
  }
  return root;
}

// Executor with robot movement for actions only
async function moveRobotToDevice(device){
  const target = document.getElementById(device);
  const robot = document.getElementById('robot');
  if(!robot) return;
  if(target){
    const rect = target.getBoundingClientRect();
    const homeRect = document.querySelector('.home-layout').getBoundingClientRect();
    const x = rect.left - homeRect.left;
    const y = rect.top - homeRect.top;
    robot.style.transform = `translate(${x}px, ${y}px)`;
    await new Promise(r=> setTimeout(r, 280));
    robot.style.transform = `translate(${x}px, ${y}px) scale(1.1)`;
    await new Promise(r=> setTimeout(r, 160));
    robot.style.transform = `translate(${x}px, ${y}px)`;
    await new Promise(r=> setTimeout(r, 140));
  }
}

async function execBlock(node){
  for(const child of node.body){
    if(child.type==='action'){
      await moveRobotToDevice(child.device);
      if(child.op==='on') turn_on(child.device); else turn_off(child.device);
    } else if(child.type==='if'){
      let cond=false;
      if(child.kind==='both') cond = if_both(child.a, child.b);
      if(child.kind==='any') cond = if_any(child.a, child.b);
      if(child.kind==='not') cond = if_not(child.a);
      if(cond){ await execBlock(child); }
    }
  }
}

function successForLevel(L){
  if(L.must_on){ for(const d of L.must_on){ if(!deviceState[d]) return false; }}
  if(L.must_off){ for(const d of L.must_off){ if(!!deviceState[d]) return false; }}
  return true;
}

async function runProgram(){
  if (running) return; running = true;
  try{
    const L = currentLevel();
    // Reset all devices to off
    Object.keys(deviceState).forEach(key => { deviceState[key] = false; const el=document.getElementById(key); if(el) el.classList.remove('on'); });
    // Apply sensors for level
    if(L.sensors){ for(const [k,v] of Object.entries(L.sensors)){ deviceState[k] = v; }}
    updateSensorDisplay();
    // Reset robot to top-right
    const robot = document.getElementById('robot'); if(robot) robot.style.transform = 'translate(0px, 0px)';

    // Parse & execute program
    const src = document.getElementById('code').value;
    const ast = parseProgram(src);
    await execBlock(ast);

    // Park robot center-ish
    if(robot) robot.style.transform = 'translate(300px, 150px)';

    // Check success
    if(successForLevel(L)){
      setFeedback('üéâ Great job! Moving to the next challenge‚Ä¶', 'good');
      setTimeout(()=>{ if(lvl < LEVELS.length-1){ lvl++; drawBoard(); } else { setFeedback('üèÜ You mastered the smart home logic set!', 'good'); } }, 1100);
    } else {
      setFeedback('Not quite. Re-check your conditions or indentation.', 'bad');
    }
  }catch(err){
    setFeedback('Error: ' + err.message, 'bad');
  }
  running = false;
}

function drawBoard(){
  const L = currentLevel();
  // Reset device state
  Object.keys(deviceState).forEach(key => { deviceState[key] = false; const el=document.getElementById(key); if(el) el.classList.remove('on'); });
  // Apply sensors for level
  if (L.sensors) { for (const [sensor, value] of Object.entries(L.sensors)) { deviceState[sensor] = value; } }
  // UI binds
  document.getElementById('lvl').textContent = (lvl + 1);
  document.getElementById('missionText').textContent = L.mission;
  document.getElementById('code').value = L.starter;
  const hint = document.getElementById('hint'); hint.textContent = L.hint; hint.style.display = 'none';
  updateSensorDisplay();
  setFeedback(L.title + ' ‚Äî ' + L.goal, 'muted');
}

// Controls
 document.getElementById('runBtn').addEventListener('click', runProgram);
 document.getElementById('resetBtn').addEventListener('click', drawBoard);
 document.getElementById('hintBtn').addEventListener('click', ()=>{
   const el = document.getElementById('hint');
   el.style.display = (el.style.display==='none' || !el.style.display) ? 'block' : 'none';
 });
 window.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.metaKey || e.ctrlKey)){ e.preventDefault(); runProgram(); }});
 // Guard missing optional tutorial elements (avoid null error)
 const hideBtn = document.getElementById('hideTutorial'); if(hideBtn){ hideBtn.addEventListener('click', ()=>{ const tut=document.getElementById('tutorial'); if(tut) tut.style.display='none'; }); }

// Navigation functions
function nextLesson() {
  window.location.href = '10. Final Project - Maze Navigator.html';
}

function backToIndex() {
  window.location.href = '../index.html';
}

// Initialize navigation buttons
function initializeNavigationButtons() {
  const nextLessonBtn = document.getElementById('nextLessonBtn');
  const backToIndexBtn = document.getElementById('backToIndexBtn');
  
  if (nextLessonBtn) {
    nextLessonBtn.addEventListener('click', nextLesson);
  }
  
  if (backToIndexBtn) {
    backToIndexBtn.addEventListener('click', backToIndex);
  }
}

// Language switching function
function switchLanguage(lang) {
  const elements = document.querySelectorAll('[data-en][data-zh]');
  elements.forEach(el => {
    el.textContent = el.getAttribute(`data-${lang}`);
  });
  
  // Update active language button
  document.querySelectorAll('.lang-toggle button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Store language preference
  localStorage.setItem('preferredLanguage', lang);
}

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', function() {
  initializeNavigationButtons();
  
  // Load saved language preference
  const savedLang = localStorage.getItem('preferredLanguage') || 'en';
  if (savedLang === 'zh') {
    // Update button states
    document.querySelectorAll('.lang-toggle button').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector('.lang-toggle button[onclick="switchLanguage(\'zh\')"]').classList.add('active');
    
    // Update content
    document.querySelectorAll('[data-en][data-zh]').forEach(element => {
      element.innerHTML = element.getAttribute('data-zh');
    });
    document.documentElement.lang = 'zh-Hant';
  }
});

// Init
 drawBoard();
</script>
    </main>
  </div>
</body>
</html>
