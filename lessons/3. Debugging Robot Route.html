<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TechReach HK - Debugging Robot Route</title>
<style>
  :root{
    --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --panel:#ffffff;      
    --ink:#0f172a;        
    --muted:#475569;      
    --accent:#2563eb;     
    --accent-2:#22c55e;   
    --accent-3:#f59e0b;   
    --accent-4:#ef4444;   
    --accent-5:#8b5cf6;   
    --line:#cbd5e1;       
    --chip:#eef2ff;
    --shadow: 0 10px 25px rgba(0,0,0,0.1);
    --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
    --good:#16a34a; 
    --bad:#dc2626;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; min-height:100vh; }
  body{ font-size:18px; line-height:1.55; }
  .wrap{max-width:1200px; margin-inline:auto; padding:24px;}
  header{
    display:flex; align-items:center; gap:20px; margin-bottom:32px; 
    background:rgba(255,255,255,0.95); padding:24px; border-radius:20px; 
    box-shadow:var(--shadow); backdrop-filter:blur(10px);
  }
  header .logo{
    width:60px;height:60px; border-radius:16px; 
    background:linear-gradient(135deg,var(--accent),#60a5fa); 
    display:grid; place-items:center; color:#fff; font-weight:800; font-size:24px;
    box-shadow: 0 8px 16px rgba(37, 99, 235, 0.3);
  }
  h1{font-size:clamp(28px,4vw,42px); margin:0; background:linear-gradient(135deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
  .subtitle{color:var(--muted); margin-top:8px; font-size:18px;}
  
  /* Language toggle */
  .lang-toggle{
    margin-left:auto; display:flex; align-items:center; gap:8px;
    background:rgba(255,255,255,0.1); padding:8px 16px; 
    border-radius:20px; border:1px solid rgba(255,255,255,0.2);
    backdrop-filter:blur(10px); transition:all 0.3s ease;
  }
  .lang-toggle:hover{background:rgba(255,255,255,0.2);}
  .lang-toggle button{
    background:none; border:none; color:var(--ink); font-size:14px; 
    font-weight:600; padding:4px 8px; border-radius:8px; 
    cursor:pointer; transition:all 0.2s ease;
  }
  .lang-toggle button.active{
    background:var(--accent); color:#fff; box-shadow:0 2px 8px rgba(37, 99, 235, 0.3);
  }
  .lang-toggle button:not(.active):hover{
    background:rgba(37, 99, 235, 0.1); color:var(--accent);
  }
  
  /* Navigation buttons - consistent sizing */
  .back-btn, .next-lesson-btn, .back-to-index-btn{
    background:var(--accent); color:#fff; border:none; padding:12px 20px; 
    border-radius:12px; font-weight:600; cursor:pointer; transition:all 0.3s ease;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    min-width: 140px; height: 48px; justify-content: center;
  }
  .back-btn:hover{
    background:#1d4ed8; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
  }
  
  /* Next Lesson button specific styling */
  .next-lesson-btn{
    background:var(--accent-5); 
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }
  .next-lesson-btn:hover{
    background:#7c3aed; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
  }
  
  /* Back to All Lessons button specific styling */
  .back-to-index-btn{
    background:var(--accent-2); 
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
  }
  .back-to-index-btn:hover{
    background:#16a34a; transform:translateY(-2px); box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
  }
  
  main{ max-width:980px; margin:0 auto; padding:16px; }
  .card{ 
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
    backdrop-filter: blur(5px); border:2px solid var(--line); border-radius:16px; 
    padding:20px; margin:12px 0; box-shadow:var(--shadow); transition:all 0.3s ease;
  }
  .card:hover{ transform:translateY(-2px); box-shadow:var(--shadow-hover); }
  .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  button{
    font-size:18px; padding:10px 14px; border-radius:10px; border:2px solid #0f172a; background:#fff; color:#0f172a;
  }
  button:hover{ outline:3px solid var(--accent); cursor:pointer; }
  button:focus{ outline:4px solid var(--accent); }
  .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#fff; border-radius:6px; padding:2px 6px; border:1px solid #0f172a; }
  /* Board */
  .board{ display:grid; grid-template-columns: repeat(10, 36px); gap:6px; }
  .cell{ width:36px; height:36px; border:2px solid #0f172a; border-radius:6px; display:flex; align-items:center; justify-content:center; background:#fff; }
  .start{ background:#d1fae5; }
  .goal{ background:#fde68a; }
  .wall{ background:#c7d2fe; position:relative; }
  .wall::after{ content:""; position:absolute; inset:6px; border:2px dashed #0f172a; border-radius:4px; opacity:.8; }
  .boardWrap{ position:relative; display:inline-block; }
  #robot{ position:absolute; top:0; left:0; width:36px; height:36px; display:flex; align-items:center; justify-content:center; pointer-events:none; will-change:transform; transition: transform 220ms ease; }
  /* Code list */
  .code{ background:#fff; border:2px dashed #0f172a; border-radius:10px; padding:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .code li{ list-style:decimal inside; margin:4px 0; padding:6px 8px; border-radius:8px; }
  .code li button{ font-size:16px; padding:6px 10px; }
  .code li.badGuess{ background:#fee2e2; }
  .code li.correct{ background:#dcfce7; }
  .muted{ opacity:.9; font-size:14px; }
  .good{ color:var(--good); font-weight:700; }
  .bad{ color:var(--bad); font-weight:700; }
  .hidden{ display:none; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">ü™≤</div>
      <div>
        <h1 data-en="Debugging Robot Route" data-zh="Èô§ÈåØÊ©üÂô®‰∫∫Ë∑ØÁ∑ö">Debugging Robot Route</h1>
        <div class="subtitle" data-en="Find and fix errors in programs" data-zh="ÊâæÂá∫‰∏¶‰øÆÂæ©Á®ãÂºè‰∏≠ÁöÑÈåØË™§">Find and fix errors in programs</div>
      </div>
      <div class="lang-toggle">
        <button class="active" onclick="switchLanguage('en')">EN</button>
        <button onclick="switchLanguage('zh')">ÁπÅ‰∏≠</button>
      </div>
    </header>
    
    <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
      <a href="2. Robot Route - Programming.html" class="back-btn">
        ‚Üê <span data-en="Previous Lesson" data-zh="‰∏ä‰∏ÄË™≤">Previous Lesson</span>
      </a>
      <button id="nextLessonBtn" class="next-lesson-btn" data-en="Next Lesson ‚Üí" data-zh="‰∏ã‰∏ÄË™≤ ‚Üí">Next Lesson ‚Üí</button>
      <button id="backToIndexBtn" class="back-to-index-btn" data-en="Back to All Lessons" data-zh="ËøîÂõûÈ¶ñÈ†Å">Back to All Lessons</button>
    </div>

<main>
  <div class="card">
    <p data-en="<strong>Learn:</strong> <em>Debugging</em> ‚Äî finding and fixing errors in code.<br/><strong>Why it matters:</strong> Even experienced programmers make mistakes. Debugging is a crucial skill." data-zh="<strong>Â≠∏ÁøíÔºö</strong> <em>Èô§ÈåØ</em> ‚Äî ÊâæÂá∫‰∏¶‰øÆÂæ©Á®ãÂºèÁ¢º‰∏≠ÁöÑÈåØË™§„ÄÇ<br/><strong>ÁÇ∫‰ªÄÈ∫ºÈáçË¶ÅÔºö</strong> Âç≥‰ΩøÁ∂ìÈ©óË±êÂØåÁöÑÁ®ãÂºèË®≠Ë®àÂ∏´‰πüÊúÉÁäØÈåØ„ÄÇÈô§ÈåØÊòØ‰∏ÄÈ†ÖÈóúÈçµÊäÄËÉΩ„ÄÇ"><strong>Learn:</strong> <em>Debugging</em> ‚Äî finding and fixing errors in code.<br/><strong>Why it matters:</strong> Even experienced programmers make mistakes. Debugging is a crucial skill.</p>
  </div>

  <div class="card">
    <div class="row">
      <strong data-en="Level" data-zh="ÈóúÂç°">Level</strong> <span id="lvl">1</span>/8
      <button id="hintBtn" data-en="Hint" data-zh="ÊèêÁ§∫">Hint</button>
    </div>
    <div id="hint" class="card hidden" data-en="Look for steps that don't make sense. Click on the wrong step to fix it!" data-zh="Â∞ãÊâæ‰∏çÂêàÁêÜÁöÑÊ≠•È©ü„ÄÇÈªûÊìäÈåØË™§ÁöÑÊ≠•È©ü‰æÜ‰øÆÂæ©ÂÆÉÔºÅ">
      Look for steps that don't make sense. Click on the wrong step to fix it!
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="boardWrap">
        <div id="board" class="board"></div>
        <div id="robot">ü§ñ</div>
      </div>
      <div style="flex:1">
        <div class="row">
          <button id="runBugBtn" data-en="Run Buggy Code" data-zh="Âü∑Ë°åÊúâÈåØË™§ÁöÑÁ®ãÂºèÁ¢º">Run Buggy Code</button>
          <button id="runFixedBtn" data-en="Run Fixed Code" data-zh="Âü∑Ë°å‰øÆÂæ©ÁöÑÁ®ãÂºèÁ¢º">Run Fixed Code</button>
          <button id="resetBtn" data-en="Reset" data-zh="ÈáçÁΩÆ">Reset</button>
          <button id="nextBtn" class="hidden" data-en="Next Level" data-zh="‰∏ã‰∏ÄÈóú">Next Level</button>
        </div>
        <p id="feedback" class="muted"></p>

        <div id="clickMode" class="code">
          <div><strong data-en="Buggy steps:" data-zh="ÊúâÈåØË™§ÁöÑÊ≠•È©üÔºö">Buggy steps:</strong> <span data-en="Click the wrong step." data-zh="ÈªûÊìäÈåØË™§ÁöÑÊ≠•È©ü„ÄÇ">Click the wrong step.</span></div>
          <ol id="codeList"></ol>
        </div>

        <div id="codeMode" class="code hidden" style="padding:0">
          <div style="padding:8px"><strong data-en="Buggy program:" data-zh="ÊúâÈåØË™§ÁöÑÁ®ãÂºèÔºö">Buggy program:</strong> <span data-en="Edit to fix, then run." data-zh="Á∑®ËºØ‰øÆÂæ©ÔºåÁÑ∂ÂæåÂü∑Ë°å„ÄÇ">Edit to fix, then run.</span></div>
          <textarea id="code" style="width:100%; height:200px; border:0; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:16px;" aria-label="code editor"></textarea>
          <div class="row" style="padding:8px">
            <button id="runCodeBtn" data-en="Run Program" data-zh="Âü∑Ë°åÁ®ãÂºè">Run Program</button>
            <button id="loadStepsBtn" data-en="Load Steps Only" data-zh="ÂÉÖËºâÂÖ•Ê≠•È©ü">Load Steps Only</button>
          </div>
          <div style="padding:0 8px 8px" class="muted" data-en="Commands: <span class='kbd'>right(n)</span>, <span class='kbd'>left(n)</span>, <span class='kbd'>up(n)</span>, <span class='kbd'>down(n)</span>, and blocks like <span class='kbd'>repeat 2:</span> ‚Ä¶ <span class='kbd'>end</span>. Use Cmd/Ctrl+Enter to run." data-zh="Êåá‰ª§Ôºö<span class='kbd'>right(n)</span>„ÄÅ<span class='kbd'>left(n)</span>„ÄÅ<span class='kbd'>up(n)</span>„ÄÅ<span class='kbd'>down(n)</span>Ôºå‰ª•ÂèäÂÉè<span class='kbd'>repeat 2:</span> ‚Ä¶ <span class='kbd'>end</span>ÈÄôÊ®£ÁöÑÂçÄÂ°ä„ÄÇ‰ΩøÁî®Cmd/Ctrl+Enter‰æÜÂü∑Ë°å„ÄÇ">Commands: <span class="kbd">right(n)</span>, <span class="kbd">left(n)</span>, <span class="kbd">up(n)</span>, <span class="kbd">down(n)</span>, and blocks like <span class="kbd">repeat 2:</span> ‚Ä¶ <span class="kbd">end</span>. Use Cmd/Ctrl+Enter to run.</div>
        </div>

        <p class="muted" data-en="Goal: Reach the <span class='kbd'>‚òÖ</span> and avoid walls." data-zh="ÁõÆÊ®ôÔºöÂà∞ÈÅî<span class='kbd'>‚òÖ</span>‰∏¶ÈÅøÈñãÁâÜÂ£Å„ÄÇ">Goal: Reach the <span class="kbd">‚òÖ</span> and avoid walls.</p>
      </div>
    </div>
  </div>
</main>
  </div>

<script>
// Language switching functionality
function switchLanguage(lang) {
  // Update button states
  document.querySelectorAll('.lang-toggle button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Update all elements with data attributes
  document.querySelectorAll('[data-en][data-zh]').forEach(element => {
    if (lang === 'zh') {
      element.innerHTML = element.getAttribute('data-zh');
    } else {
      element.innerHTML = element.getAttribute('data-en');
    }
  });
  
  // Update HTML lang attribute
  document.documentElement.lang = lang === 'zh' ? 'zh-Hant' : 'en';
  
  // Store language preference
  localStorage.setItem('preferredLanguage', lang);
}

// Load saved language preference on page load
document.addEventListener('DOMContentLoaded', function() {
  const savedLang = localStorage.getItem('preferredLanguage') || 'en';
  if (savedLang === 'zh') {
    // Update button states
    document.querySelectorAll('.lang-toggle button').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector('.lang-toggle button[onclick="switchLanguage(\'zh\')"]').classList.add('active');
    
    // Update content
    document.querySelectorAll('[data-en][data-zh]').forEach(element => {
      element.innerHTML = element.getAttribute('data-zh');
    });
    document.documentElement.lang = 'zh-Hant';
  }
  
  // Initialize navigation buttons
  initializeNavigationButtons();
});

// Navigation functions
function nextLesson(){
  console.log('Next Lesson button clicked!');
  window.location.href = '4. Pattern Lab v4.html';
}

function backToIndex(){
  console.log('Back to All Lessons button clicked!');
  window.location.href = '../index.html';
}

function initializeNavigationButtons(){
  // Bind Next Lesson button
  const nextLessonBtn = document.getElementById('nextLessonBtn');
  if (nextLessonBtn) {
    nextLessonBtn.addEventListener('click', nextLesson);
  }
  
  // Bind Back to All Lessons button
  const backToIndexBtn = document.getElementById('backToIndexBtn');
  if (backToIndexBtn) {
    backToIndexBtn.addEventListener('click', backToIndex);
  }
}

</script>
<script>
// Directions and helpers
const DIRS = { Right:[1,0], Left:[-1,0], Up:[0,-1], Down:[0,1] };
let running = false;
let lvl = 0;

// 8 levels: 1-4 click mode, 5-8 code mode
const LEVELS = [
  // 1
  { mode:'click', start:[0,9], goal:[3,9], walls:[], correct:['Right','Right','Right'], buggy:['Right','Right','Up'], bugIndex:2, prompt:'One step goes the wrong way.' },
  // 2
  { mode:'click', start:[0,9], goal:[5,9], walls:[[2,9],[3,9]], correct:['Right','Up','Right','Right','Right','Down','Right'], buggy:['Right','Right','Right','Right','Right','Down','Right'], bugIndex:[0,1], prompt:'A step should go Up to avoid the wall.' },
  // 3
  { mode:'click', start:[0,9], goal:[7,7], walls:[[1,9],[1,8],[2,8],[3,8]], correct:['Up','Up','Right','Right','Right','Right','Right','Right','Right'], buggy:['Right','Up','Right','Right','Right','Right','Right','Right','Right'], bugIndex:0, prompt:'Early turn is wrong.' },
  // 4
  { mode:'click', start:[0,9], goal:[9,6], walls:[[2,9],[3,9],[4,9],[5,9],[6,9]], correct:['Up','Up','Up','Right','Right','Right','Right','Right','Right','Right','Right','Right'], buggy:['Right','Up','Up','Right','Right','Right','Right','Right','Right','Right','Right'], bugIndex:0, prompt:'Must go Up first.' },
  // 5
  { mode:'code', start:[0,9], goal:[9,0], walls:[[1,8],[2,8],[3,8],[4,8],[5,8],[6,8],[7,8]], buggyCode:`right(7)\nup(9)\nright(2)\n`, hint:'Ceiling tunnel: go up first, then right carefully.' },
  // 6
  { mode:'code', start:[1,9], goal:[8,4], walls:[[1,8],[2,8],[3,8],[4,8],[5,8],[6,8],[7,8],[3,7],[3,6]], buggyCode:`right(2)\nup(5)\nright(5)\n`, hint:'There is a pillar at x=3; route around it.' },
  // 7
  { mode:'code', start:[0,9], goal:[9,3], walls:[[1,9],[2,9],[3,9],[4,9],[5,9],[6,9],[6,8],[6,7],[6,6]], buggyCode:`right(7)\nup(6)\nright(2)\n`, hint:'A tall wall at x=6 requires going up before crossing.' },
  // 8
  { mode:'code', start:[0,9], goal:[9,0], walls:[[1,9],[2,9],[3,9],[4,9],[5,9],[6,9],[6,8],[6,7],[5,7],[4,7],[3,7],[2,7],[2,6],[2,5],[2,4],[3,4],[4,4],[5,4],[6,4],[7,4]], buggyCode:`repeat 4:\n  right(2)\n  up()\nend\nright(1)\nup(5)\n`, hint:'Maze-ish: small ups and rights; check counts.' }
];

function currentLevel(){ return LEVELS[lvl]; }

function setFeedback(msg, cls){
  const el = document.getElementById('feedback');
  el.className = cls ? cls : 'muted';
  el.textContent = msg;
}

function drawBoard(){
  const L = currentLevel();
  const b = document.getElementById('board');
  b.innerHTML = '';
  const stepPx = 36+6;
  const robot = document.getElementById('robot');
  robot.style.transform = `translate(${L.start[0]*stepPx}px, ${L.start[1]*stepPx}px)`;
  for (let y=0;y<10;y++){
    for (let x=0;x<10;x++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      if (L.walls.some(w=> w[0]===x && w[1]===y)) cell.classList.add('wall');
      if (x===L.start[0] && y===L.start[1]) cell.classList.add('start');
      if (x===L.goal[0] && y===L.goal[1]){ cell.classList.add('goal'); cell.textContent = '‚òÖ'; }
      b.appendChild(cell);
    }
  }
  document.getElementById('lvl').textContent = (lvl+1);
  const clickMode = document.getElementById('clickMode');
  const codeMode = document.getElementById('codeMode');
  const runBug = document.getElementById('runBugBtn');
  const runFixed = document.getElementById('runFixedBtn');
  const runCodeBtn = document.getElementById('runCodeBtn');
  const loadStepsBtn = document.getElementById('loadStepsBtn');
  if (L.mode==='click'){
    clickMode.classList.remove('hidden');
    codeMode.classList.add('hidden');
    runBug.disabled = false;
    runFixed.disabled = false;
    if (runCodeBtn) runCodeBtn.disabled = true;
    if (loadStepsBtn) loadStepsBtn.disabled = true;
    setFeedback(L.prompt + ' Run the buggy code to see it.', 'muted');
    renderClickList();
  } else {
    clickMode.classList.add('hidden');
    codeMode.classList.remove('hidden');
    runBug.disabled = true;
    runFixed.disabled = true;
    if (runCodeBtn) runCodeBtn.disabled = false;
    if (loadStepsBtn) loadStepsBtn.disabled = false;
    const ta = document.getElementById('code');
    ta.value = L.buggyCode;
    setFeedback(L.hint + ' Edit the code and run.', 'muted');
  }
  document.getElementById('nextBtn').classList.add('hidden');
}

function renderClickList(){
  const L = currentLevel();
  const list = document.getElementById('codeList');
  list.innerHTML = '';
  L.buggy.forEach((mv, i)=>{
    const li = document.createElement('li');
    const btn = document.createElement('button');
    btn.textContent = `${mv}()`;
    btn.addEventListener('click', ()=> onPick(i, li));
    li.appendChild(btn);
    list.appendChild(li);
  });
}

function applyMove(pos, mv){
  const d = DIRS[mv];
  return { x: pos.x + d[0], y: pos.y + d[1] };
}

function inBounds(p){
  return p.x>=0 && p.x<10 && p.y>=0 && p.y<10;
}
function isWall(p){
  return currentLevel().walls.some(w=> w[0]===p.x && w[1]===p.y);
}

async function animate(steps){
  if (running) return;
  running = true;
  const stepPx = 36+6;
  const robot = document.getElementById('robot');
  const L = currentLevel();
  let pos = { x: L.start[0], y: L.start[1] };
  for (let i=0;i<steps.length;i++){
    const next = applyMove(pos, steps[i]);
    if (!inBounds(next)){
      setFeedback(`Went out of bounds at step ${i+1}.`, 'bad');
      break;
    }
    if (isWall(next)){
      setFeedback(`Hit a wall at step ${i+1}.`, 'bad');
      break;
    }
    pos = next;
    robot.style.transform = `translate(${pos.x*stepPx}px, ${pos.y*stepPx}px)`;
    await new Promise(r=> setTimeout(r, 230));
  }
  if (pos.x===L.goal[0] && pos.y===L.goal[1]){
    setFeedback('Program reached the goal.', 'good');
    // Auto-advance for code levels; show Next for click levels
    if (L.mode==='code'){
      setTimeout(()=> nextLevel(), 600);
    } else {
      document.getElementById('nextBtn').classList.remove('hidden');
    }
  }
  running = false;
}

function onPick(index, li){
  const L = currentLevel();
  const isCorrect = Array.isArray(L.bugIndex) ? L.bugIndex.includes(index) : index === L.bugIndex;
  
  if (isCorrect){
    li.classList.add('correct');
    setFeedback('Correct! Nice catch. Advancing‚Ä¶', 'good');
    setTimeout(()=> nextLevel(), 800);
  } else {
    li.classList.add('badGuess');
    setFeedback('Not quite. Try another step.', 'bad');
  }
}

function nextLevel(){
  if (lvl < LEVELS.length-1){
    lvl++;
    drawBoard();
  } else {
    setFeedback('You finished all debugging levels! üéâ', 'good');
  }
}

// Python-style mini parser for code levels
const DIR_NAME = { right:'Right', left:'Left', up:'Up', down:'Down' };

function splitSemicolonsPreserve(lines){
  const out = [];
  lines.forEach(line=>{
    const parts = line.split(';').map(s=> s.trim()).filter(Boolean);
    out.push(...parts);
  });
  return out;
}

function parseSimpleCommand(cmd){
  const mm = cmd.match(/^(right|left|up|down)\s*\(\s*(\d+)?\s*\)$/i);
  if (mm){
    const dir = DIR_NAME[mm[1].toLowerCase()];
    const n = mm[2] ? parseInt(mm[2],10) : 1;
    return Array(n).fill(dir);
  }
  const m2 = cmd.match(/^move\s*\(\s*['\"](right|left|up|down)['\"]\s*,\s*(\d+)\s*\)$/i);
  if (m2){
    const dir = DIR_NAME[m2[1].toLowerCase()];
    const n = parseInt(m2[2],10);
    return Array(n).fill(dir);
  }
  return null;
}

function compileProgram(src){
  const rawLines = src.replace(/\r/g,'').split("\n").map(s=> s.trim());
  const lines = rawLines.filter(Boolean);
  let i = 0;
  function parseBlock(){
    let steps = [];
    while (i < lines.length){
      const line = lines[i];
      if (/^end$/i.test(line)){ i++; break; }
      const rep = line.match(/^repeat\s+(\d+)\s*:\s*$/i);
      if (rep){
        i++;
        const times = parseInt(rep[1],10);
        const inner = parseBlock();
        for (let t=0;t<times;t++){ steps.push(...inner); }
        continue;
      }
      const parts = splitSemicolonsPreserve([line]);
      for (const part of parts){
        const simple = parseSimpleCommand(part);
        if (simple){ steps.push(...simple); }
        else if (/^repeat\s+\d+\s*:\s*end$/i.test(part)){
          continue;
        } else {
          throw new Error('Unknown command: ' + part);
        }
      }
      i++;
    }
    return steps;
  }
  i = 0;
  const result = [];
  while (i < lines.length){
    const line = lines[i];
    const rep = line.match(/^repeat\s+(\d+)\s*:\s*$/i);
    if (rep){
      i++;
      const times = parseInt(rep[1],10);
      const inner = parseBlock();
      for (let t=0;t<times;t++){ result.push(...inner); }
      continue;
    }
    const parts = splitSemicolonsPreserve([line]);
    for (const part of parts){
      const simple = parseSimpleCommand(part);
      if (simple){ result.push(...simple); }
      else if (/^end$/i.test(part)){
        throw new Error("Unexpected 'end' without a matching 'repeat'.");
      } else {
        throw new Error('Unknown command: ' + part);
      }
    }
    i++;
  }
  return result;
}

function loadFromCode(){
  try{
    const steps = compileProgram(document.getElementById('code').value);
    window._compiled = steps;
    setFeedback('Loaded ' + steps.length + ' steps from code.', 'good');
  } catch(err){
    setFeedback(err.message, 'bad');
  }
}

async function runFromCode(){
  try{
    const steps = compileProgram(document.getElementById('code').value);
    window._compiled = steps;
    await animate(steps);
    // advance if reached goal (animate sets next button)
  } catch(err){
    setFeedback(err.message, 'bad');
  }
}

// Bind UI
document.addEventListener('click', (e)=>{
  const L = currentLevel();
  if (e.target && e.target.id === 'runBugBtn' && L.mode==='click') animate(L.buggy);
  if (e.target && e.target.id === 'runFixedBtn' && L.mode==='click') animate(L.correct);
  if (e.target && e.target.id === 'resetBtn'){
    drawBoard();
    document.querySelectorAll('.code li').forEach(li=> li.className='');
  }
  if (e.target && e.target.id === 'nextBtn') nextLevel();
  if (e.target && e.target.id === 'runCodeBtn' && L.mode==='code') runFromCode();
  if (e.target && e.target.id === 'loadStepsBtn' && L.mode==='code') loadFromCode();
});

// Keyboard: Cmd/Ctrl+Enter to run in code mode
window.addEventListener('keydown', (e)=>{
  const L = currentLevel();
  if (L.mode==='code' && e.key==='Enter' && (e.metaKey || e.ctrlKey)){
    e.preventDefault();
    runFromCode();
  }
});

drawBoard();
</script>
</body>
</html>


